<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thiên Mệnh Chi Tỷ Lý Huynh - Realtime RPG (Offline)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        // --- OFFLINE SAVE FUNCTIONS (LOCAL STORAGE) ---
        
        // Ghi dữ liệu vào Local Storage
        window.saveGame = function(state) {
            try {
                const stateToSave = { ...state };
                // Loại bỏ các interval không thể lưu trữ
                delete stateToSave.tuXianInterval;
                delete stateToSave.combatInterval;
                delete stateToSave.npcCombatInterval;
                delete stateToSave.timeTickInterval;
                delete stateToSave.healthRegenInterval;
                delete stateToSave.currentMonster; 
                delete stateToSave.currentNPCCombat;

                localStorage.setItem('tu_tien_save_offline', JSON.stringify(stateToSave));
                window.logToConsole("•ĐÃ LƯU: Tiến trình Tu Luyện của bạn đã được lưu vào Local Storage.");
            } catch (e) {
                console.error("Lỗi khi lưu trữ Local Storage:", e);
                window.logToConsole("§LỖI: Không thể lưu trữ dữ liệu tu luyện vào trình duyệt.");
            }
        };

        // Đọc dữ liệu từ Local Storage
        window.loadGame = function() {
            try {
                const savedData = localStorage.getItem('tu_tien_save_offline');
                if (savedData) {
                    const loadedState = JSON.parse(savedData);
                    // Kiểm tra sơ bộ để tránh tải dữ liệu rỗng
                    if (Object.keys(loadedState).length > 5) {
                        return loadedState;
                    }
                }
                return null;
            } catch (e) {
                console.error("Lỗi khi tải dữ liệu Local Storage:", e);
                return null;
            }
        };

        // Dùng cho nút Lưu Trữ Tiến Trình
        window.handleActionSave = function() {
            window.saveGame(gameState);
        };
    </script>

    <style>
        /* Custom Pixel Art Styling and Layout Fixes */
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

        :root {
            --pixel-font: 'VT323', monospace;
            --primary-color: #3b82f6; /* Blue */
            --dark-bg: #1f2937; /* Gray 800 */
            --console-bg: #111827; /* Gray 900 */
            --border-color: #4b5563; /* Gray 600 */
        }

        body {
            font-family: var(--pixel-font);
            background-color: var(--dark-bg);
            color: #d1d5db;
        }

        .pixel-border {
            border: 4px solid var(--border-color);
            box-shadow: 6px 6px 0px rgba(0, 0, 0, 0.5);
            border-radius: 0;
        }
        .pixel-card {
            border: 2px solid var(--border-color);
            padding: 8px;
        }

        /* --- BUTTON STYLING (Improved Hover/Active) --- */
        .game-button {
            font-size: 1.25rem;
            text-shadow: 2px 2px 0px rgba(0, 0, 0, 0.7);
            border: 3px solid #6ee7b7; /* Emerald 300 */
            background-color: #047857; /* Emerald 700 */
            transition: all 0.1s;
            line-height: 1;
            padding: 8px 12px;
            cursor: pointer;
            box-shadow: 2px 2px 0px #10b981;
        }

        .game-button:hover:not(:disabled) {
            background-color: #065f46;
            box-shadow: 4px 4px 0px #10b981;
            transform: translate(-2px, -2px);
        }

        .game-button:active:not(:disabled) {
            background-color: #059669;
            box-shadow: 0px 0px 0px #059669;
            transform: translate(0, 0);
        }
        
        .game-button:disabled {
             cursor: not-allowed;
             opacity: 0.6;
        }

        .tab-button {
             background-color: #374151; /* Gray 700 */
             border-bottom: 3px solid var(--border-color);
        }
        .tab-button.active {
             background-color: #4b5563; /* Gray 600 */
             border-bottom: 3px solid #fcd34d; /* Amber */
             color: #fcd34d;
        }


        /* --- CONSOLE AND PROGRESS BARS --- */
        #game-console {
            height: 150px;
            overflow-y: auto;
            white-space: pre-wrap;
            line-height: 1.2;
            padding: 1rem;
            background-color: var(--console-bg);
        }
        
        .progress-bar-hp, .progress-bar-exp, .progress-bar-monster-hp, .progress-bar-mp {
            background-color: #4b5563;
            height: 12px;
            border: 1px solid var(--border-color);
        }

        .progress-fill-hp {
            height: 100%;
            background-color: #ef4444; /* Red */
            transition: width 0.3s ease-in-out;
        }
        .progress-fill-exp {
            height: 100%;
            background-color: #3b82f6; /* Blue */
            transition: width 0.3s ease-in-out;
        }
        .progress-fill-monster-hp {
            height: 100%;
            background-color: #fcd34d; /* Amber/Yellow for Monster */
            transition: width 0.3s ease-in-out;
        }
        .progress-fill-mp {
            height: 100%;
            background-color: #9333ea; /* Purple for MP/Mana */
            transition: width 0.3s ease-in-out;
        }
    </style>
</head>
<body class="p-4 flex justify-center items-center min-h-screen">

    <div id="game-container" class="w-full max-w-5xl pixel-border bg-gray-800 p-6">
        <h1 class="text-4xl text-center mb-4 text-yellow-300">HÀNH TRÌNH VÔ THƯỢNG</h1>
        <p id="user-id-display" class="text-sm text-center mb-2 text-gray-500">Chế độ: OFFLINE (Lưu trữ cục bộ)</p>
        <p id="time-display" class="text-xl text-center mb-4 text-orange-400">Ngày: 1 | Tháng: 1</p>


        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            
            <div id="stats-panel" class="lg:col-span-1 flex flex-col space-y-4">
                
                <div class="pixel-card bg-gray-700">
                    <h2 class="text-xl mb-2 text-yellow-300 border-b border-gray-500">THÔNG TIN TU GIẢ</h2>
                    <p>Cảnh Giới: <span id="stat-realm" class="text-green-400"></span></p>
                    <p>Công Pháp: <span id="stat-method" class="text-yellow-400">Chưa học</span></p>
                    <p>Linh Thạch: <span id="stat-money" class="text-yellow-400"></span></p>
                    <p>Linh Căn: <span id="stat-spirit-root" class="text-purple-400"></span></p>
                    <p>Căn Cốt: <span id="stat-bone" class="text-orange-400"></span></p>
                </div>
                
                <div class="pixel-card bg-gray-700">
                    <h2 class="text-xl mb-2 text-red-400 border-b border-gray-500">CHỈ SỐ CHIẾN ĐẤU</h2>
                    <p>Tấn Công: <span id="stat-attack" class="text-red-400">0</span></p>
                    <p>Phòng Thủ: <span id="stat-defense" class="text-blue-400">0</span></p>

                    <p class="mt-2">HP: <span id="stat-hp" class="text-red-400">0/0</span></p>
                    <div class="progress-bar-hp mt-1">
                        <div id="hp-progress" class="progress-fill-hp" style="width: 100%"></div>
                    </div>
                    
                    <p class="mt-2">Linh Khí (MP): <span id="stat-mp" class="text-purple-400">0/0</span></p>
                    <div class="progress-bar-mp mt-1">
                        <div id="mp-progress" class="progress-fill-mp" style="width: 100%"></div>
                    </div>
                </div>

                <div class="pixel-card bg-gray-700">
                    <h2 class="text-xl mb-2 text-blue-400 border-b border-gray-500">TIẾN TRÌNH TU VI</h2>
                    <p class="text-base mb-1">Tu Vi: <span id="stat-exp" class="text-blue-400">0</span></p>
                    <div class="progress-bar-exp">
                        <div id="exp-progress" class="progress-fill-exp" style="width: 0%"></div>
                    </div>
                    <button class="game-button p-2 text-base w-full mt-3" onclick="handleActionSave()">LƯU TRỮ TIẾN TRÌNH</button>
                </div>

            </div>

            <div class="lg:col-span-3 flex flex-col">
                <div id="main-tabs" class="grid grid-cols-4 gap-0 mb-0 border-b-4 border-gray-600">
                    <button id="tab-TuoXian" class="tab-button p-3 text-xl active" onclick="switchView('TuoXian')">TỌA THIỀN</button>
                    <button id="tab-Combat" class="tab-button p-3 text-xl" onclick="switchView('Combat')">CHIẾN ĐẤU</button>
                    <button id="tab-Trade" class="tab-button p-3 text-xl" onclick="switchView('Trade')">THƯƠNG HỘI</button>
                    <button id="tab-NPC" class="tab-button p-3 text-xl" onclick="switchView('NPC')">NPC</button>
                </div>

                <div id="main-content" class="min-h-72 pixel-border bg-gray-700 p-4 flex-grow">
                    </div>

                <div id="game-console" class="mt-4 pixel-border">
                    </div>
            </div>

        </div>
    </div>

    <script>
        // --- GAME DATA AND CONFIGURATION ---
        const GAME_TICK_INTERVAL = 1000; // 1 second
        const DAY_DURATION_TICKS = 60; // 60 seconds = 1 day

        // CĂN CỐT (Total Rarity of last 3 is 10%)
        const BONE_QUALITIES = [
            { name: "Phế Vật Cốt", multiplier: 0.5, breakthroughBonus: -0.10, hpBonus: 0.5, rarity: 15 },
            { name: "Phàm Cốt", multiplier: 1.0, breakthroughBonus: 0.00, hpBonus: 1.0, rarity: 25 },
            { name: "Linh Cốt", multiplier: 1.5, breakthroughBonus: 0.05, hpBonus: 1.5, rarity: 25 },
            { name: "Tiên Cốt", multiplier: 2.0, breakthroughBonus: 0.10, hpBonus: 2.0, rarity: 20 },
            { name: "Thần Cốt", multiplier: 3.0, breakthroughBonus: 0.15, hpBonus: 3.0, rarity: 5 }, // 5%
            { name: "Thiên Cốt (Vô Song)", multiplier: 4.0, breakthroughBonus: 0.20, hpBonus: 4.0, rarity: 3 }, // 3%
            { name: "Thánh Cốt (Cấm Kỵ)", multiplier: 5.0, breakthroughBonus: 0.25, hpBonus: 5.0, rarity: 1.5 }, // 1.5%
            { name: "Hỗn Độn Cốt (Tuyệt Thế)", multiplier: 6.0, breakthroughBonus: 0.30, hpBonus: 6.0, rarity: 0.5 }, // 0.5%
        ];
        
        // LINH CĂN (Total Rarity of last 3 is 10%)
        const SPIRIT_ROOTS = [
            { name: "Phế Linh Căn", multiplier: 0.5, mpBonus: 0.5, mpRegen: 0.5, rarity: 15 },
            { name: "Ngũ Hành Căn", multiplier: 1.0, mpBonus: 1.0, mpRegen: 1.0, rarity: 25 },
            { name: "Biến Dị Căn (Phong/Lôi)", multiplier: 1.5, mpBonus: 1.5, mpRegen: 1.5, rarity: 25 },
            { name: "Đơn Linh Căn (Hoàn Mỹ)", multiplier: 2.5, mpBonus: 2.5, mpRegen: 2.0, rarity: 20 },
            { name: "Thiên Linh Căn", multiplier: 4.0, mpBonus: 4.0, mpRegen: 3.0, rarity: 5 }, // 5%
            { name: "Huyền Băng Căn (Hiếm)", multiplier: 5.0, mpBonus: 5.0, mpRegen: 4.0, rarity: 3 }, // 3%
            { name: "Thái Dương Căn (Cực Hiếm)", multiplier: 6.0, mpBonus: 6.0, mpRegen: 5.0, rarity: 1.5 }, // 1.5%
            { name: "Hỗn Độn Căn (Vô Thượng)", multiplier: 8.0, mpBonus: 8.0, mpRegen: 6.0, rarity: 0.5 }, // 0.5%
        ];
        
        // CÔNG PHÁP (Cultivation Methods) - NEW
        const CULTIVATION_METHODS = [
            { name: "Phàm Nhân Tọa Công", price: 0, type: "default", description: "Công pháp cơ bản, không có hiệu ứng đặc biệt." },
            { name: "Thái Huyền Kiếm Quyết", price: 5000, type: "attack", bonus: 10, description: "Tăng 10 điểm Tấn Công cơ bản khi luyện. (Tàng Kinh Các)" },
            { name: "Vạn Pháp Quy Nguyên Công", price: 5000, type: "defense", bonus: 10, description: "Tăng 10 điểm Phòng Thủ cơ bản khi luyện. (Tàng Kinh Các)" },
        ];


        const REALMS = [
            { name: "Phàm Nhân", maxExp: 1000, color: "text-gray-400", baseDmg: 5, baseDef: 0 },
            { name: "Luyện Khí Tầng 1", maxExp: 2500, color: "text-yellow-400", baseDmg: 15, baseDef: 5 },
            { name: "Luyện Khí Tầng 2", maxExp: 5000, color: "text-yellow-400", baseDmg: 25, baseDef: 10 },
            { name: "Luyện Khí Tầng 3", maxExp: 8000, color: "text-yellow-400", baseDmg: 35, baseDef: 15 },
            { name: "Trúc Cơ Sơ Kỳ", maxExp: 15000, color: "text-green-400", baseDmg: 60, baseDef: 25 },
            { name: "Trúc Cơ Trung Kỳ", maxExp: 30000, color: "text-green-400", baseDmg: 90, baseDef: 40 },
            { name: "Kim Đan Sơ Kỳ", maxExp: 60000, color: "text-red-400", baseDmg: 150, baseDef: 70 },
            { name: "Kim Đan Trung Kỳ", maxExp: 100000, color: "text-red-400", baseDmg: 200, baseDef: 100 },
            { name: "Nguyên Anh Sơ Kỳ", maxExp: 200000, color: "text-purple-400", baseDmg: 350, baseDef: 180 },
            { name: "Nguyên Anh Trung Kỳ", maxExp: 400000, color: "text-purple-400", baseDmg: 500, baseDef: 250 },
            { name: "Hóa Thần Sơ Kỳ", maxExp: 800000, color: "text-indigo-400", baseDmg: 700, baseDef: 350 },
            { name: "Hóa Thần Trung Kỳ", maxExp: 1500000, color: "text-indigo-400", baseDmg: 1000, baseDef: 500 },
            { name: "Luyện Hư", maxExp: 3000000, color: "text-pink-400", baseDmg: 1500, baseDef: 750 },
            { name: "Hợp Thể", maxExp: 6000000, color: "text-pink-400", baseDmg: 2500, baseDef: 1000 },
            { name: "Đại Thừa", maxExp: 12000000, color: "text-cyan-400", baseDmg: 4000, baseDef: 1500 },
            { name: "Độ Kiếp (Cực Hạn)", maxExp: 999999999, color: "text-yellow-100", baseDmg: 6000, baseDef: 2500 },
        ];
        
        const SKILLS = [
            { name: "Đột Kích (Cơ bản)", damageMultiplier: 1.5, mpCost: 20, description: "Gây 150% sát thương, tốn 20 MP." }
        ];

        const MONSTERS = [
            { id: 0, name: "Linh Xà Độc", minRealm: 0, requiredRealm: "Phàm Nhân", baseHp: 50, baseAtk: 5, exp: 100, loot: { 'Yêu Thú Tàn Thi': 1.0, 'Bình Phàm Đan': 0.1 } },
            { id: 1, name: "Hắc Báo Y", minRealm: 2, requiredRealm: "Luyện Khí Tầng 2", baseHp: 150, baseAtk: 15, exp: 300, loot: { 'Yêu Thú Tàn Thi': 0.7, 'Hắc Báo Bì': 0.5, 'Linh Căn Thảo': 0.05 } },
            { id: 2, name: "Phi Thiên Hổ", minRealm: 4, requiredRealm: "Trúc Cơ Sơ Kỳ", baseHp: 500, baseAtk: 40, exp: 1000, loot: { 'Linh Thú Cốt': 0.7, 'Thiên Lang Đan': 0.2, 'Kim Tinh Thạch': 0.01 } },
            { id: 3, name: "Tứ Giai Ma Thú", minRealm: 7, requiredRealm: "Kim Đan Sơ Kỳ", baseHp: 1200, baseAtk: 80, exp: 2500, loot: { 'Ma Thú Huyết': 0.8, 'Huyền Thiết': 0.3, 'Bí Pháp Quyển': 0.005, 'Long Lân': 0.001 } }, // Đồ hiếm 0.1%
            { id: 4, name: "Thượng Cổ Ma Long", minRealm: 10, requiredRealm: "Nguyên Anh Sơ Kỳ", baseHp: 5000, baseAtk: 200, exp: 8000, loot: { 'Long Lân': 0.9, 'Nội Đan': 0.5, 'Thiên Thần Đan': 0.005 } }, // Đồ hiếm 0.5%
            { id: 5, name: "Cửu Vỹ Hồ Ly", minRealm: 13, requiredRealm: "Luyện Hư", baseHp: 15000, baseAtk: 500, exp: 30000, loot: { 'Hồ Yêu Nội Đan': 1.0, 'Huyền Thiết': 0.5, 'Tử Kim Linh Thạch': 0.05 } }, // Đồ hiếm 5%
        ];

        const LOOT_PRICES = {
            'Yêu Thú Tàn Thi': { price: 20, type: 'common' },
            'Bình Phàm Đan': { price: 50, type: 'common' },
            'Hắc Báo Bì': { price: 80, type: 'common' },
            'Linh Căn Thảo': { price: 300, type: 'common' },
            'Linh Thú Cốt': { price: 150, type: 'common' },
            'Thiên Lang Đan': { price: 500, type: 'common' },
            'Ma Thú Huyết': { price: 400, type: 'common' },
            'Huyền Thiết': { price: 1000, type: 'common' },
            'Kim Tinh Thạch': { price: 5000, type: 'rare' }, 
            'Bí Pháp Quyển': { price: 15000, type: 'rare' },
            'Long Lân': { price: 8000, type: 'rare' },
            'Nội Đan': { price: 20000, type: 'rare' },
            'Hồ Yêu Nội Đan': { price: 50000, type: 'rare' },
            'Thiên Thần Đan': { price: 100000, type: 'super_rare' },
            'Tử Kim Linh Thạch': { price: 500000, type: 'super_rare' },
        };

        const TRADE_ITEMS = [
            { name: "Linh Khí Phù", price: 100, bonus: 500, type: "exp", description: "Tăng 500 Tu Vi." },
            { name: "Giáp Da Thú", price: 200, bonus: 10, type: "def", description: "Tăng 10 điểm Phòng Thủ vĩnh viễn." },
            { name: "Trúc Cơ Đan", price: 5000, bonus: 1, type: "breakthrough", description: "Đảm bảo đột phá thành công cảnh giới hiện tại." },
        ];
        
        // Items for Daily Shop Special & Monthly Auction
        const SPECIAL_ITEMS = [
            { name: "Hồi Lực Đan", price: 500, type: "mp", bonus: 50, description: "Hồi 50 Linh Khí (MP)." },
            { name: "Trúc Nhan Đan", price: 1000, type: "hp", bonus: 0.5, description: "Tăng 0.5% HP Tối Đa vĩnh viễn (Tính theo cấp độ)." },
            { name: "Tấn Công Phù", price: 2000, type: "atk", bonus: 20, description: "Tăng 20 điểm Tấn Công vĩnh viễn." },
        ];

        const AUCTION_ITEMS = [
            { name: "Cải Cốt Đan", basePrice: 50000, type: "bone_change", description: "Cơ hội cải tạo Căn Cốt cao hơn (Cực Hiếm)." },
            { name: "Tẩy Tủy Đan", basePrice: 80000, type: "root_change", description: "Cơ hội cải tạo Linh Căn cao hơn (Cực Hiếm)." },
            { name: "Thần Binh Phù", basePrice: 150000, type: "atk_mega", bonus: 100, description: "Tăng 100 điểm Tấn Công vĩnh viễn (Siêu phẩm)." },
            { name: "Huyết Sát Ma Kinh", basePrice: 50000, type: "cultivation_method", description: "Công pháp hiếm, tăng 20 Tấn Công, giảm 10 Phòng Thủ. (Đấu Giá)" }, // ADDED CULTIVATION METHOD
        ];
        
        const MOCK_NPCS = [
            { id: 'thanhvan', name: "Sư Tỷ Thanh Vân", realm: "Luyện Khí Tầng 3", baseAtk: 50, baseDef: 20, baseHp: 300, isChallengable: false, description: "Bận rộn luyện đan, có thể chỉ điểm công pháp." },
            { id: 'truonglao', name: "Trưởng Lão Dược Các", realm: "Trúc Cơ Trung Kỳ", baseAtk: 100, baseDef: 50, baseHp: 800, isChallengable: false, description: "Người quản lý vật phẩm hiếm, có thể trao đổi bảo vật." },
            { id: 'thientai', name: "Thiên Tài Huyền Băng", realm: "Kim Đan Sơ Kỳ", baseAtk: 200, baseDef: 100, baseHp: 1500, isChallengable: true, reward: 10000, description: "Tu Giả kiêu ngạo, có thể thách đấu để nhận thưởng lớn." },
            { id: 'sugia', name: "Sư Già Tiền Bối", realm: "Nguyên Anh Hậu Kỳ", baseAtk: 500, baseDef: 250, baseHp: 5000, isChallengable: true, reward: 50000, description: "Cao nhân ẩn dật, có thể thách đấu để nhận thưởng khủng." }
        ];

        // --- GAME STATE (Initial Values for New Game) ---
        const initialGameState = {
            realmIndex: 0,
            experience: 0,
            spiritStone: 100, 
            currentHP: 100,
            maxHP: 100,
            currentMP: 50, // Initial MP
            maxMP: 50,     // Initial Max MP
            mpRegenRate: 1, // Initial Regen
            baseAttack: 10,
            baseDefense: 5,
            spiritRoot: null, 
            boneQuality: null, 
            spiritRootName: null, 
            boneQualityName: null, 
            knownCultivationMethods: [], // NEW: Danh sách công pháp đã học
            activeCultivationMethod: null, // NEW: Công pháp đang sử dụng (Chưa học)
            // Removed: cultivationMethod: ['Thái Huyền Kiếm Quyết', 'Vạn Pháp Quy Nguyên Công', 'Huyết Sát Ma Kinh'][Math.floor(Math.random() * 3)],
            inventory: { 'Yêu Thú Tàn Thi': 0, 'Bình Phàm Đan': 0, 'Hắc Báo Bì': 0, 'Kim Tinh Thạch': 0, 'Bí Pháp Quyển': 0, 'Trúc Cơ Đan': 0, 'Linh Căn Thảo': 0 },
            currentView: 'TuoXian',
            currentMonster: null, 
            currentNPCCombat: null, // NPC đang chiến đấu
            
            // Time & Shop States
            currentDay: 1, // Day 1-30 in a month
            lastAuctionDay: 0,
            dailyItem: null,

            // Fix bug NPC: theo dõi tương tác (Chỉ được nhận 1 lần)
            npcInteractions: {
                thanhvan_advice_atk: false,
                sugia_advice_def: false
            }
        };

        let gameState = {}; // State will be loaded/initialized here

        let tuXianInterval = null;
        let combatInterval = null;
        let npcCombatInterval = null;
        let healthRegenInterval = null;
        let timeTickInterval = null;
        let selectedNPC = null; 
        let gameTicks = 0; // for day tracking


        // --- CORE GAME FUNCTIONS ---
        
        window.logToConsole = function(message) {
            const consoleElement = document.getElementById('game-console');
            let logMessage = `<p class="text-sm my-1">${message}</p>`;

            if (message.startsWith("§")) {
                logMessage = `<p class="text-base my-1 font-bold text-yellow-300">${message.substring(1)}</p>`;
            } else if (message.startsWith("•")) {
                logMessage = `<p class="text-sm my-1 text-green-400">${message}</p>`;
            } else if (message.startsWith("X")) {
                 logMessage = `<p class="text-sm my-1 text-red-500">${message.substring(1)}</p>`;
            } else if (message.startsWith("!")) {
                 logMessage = `<p class="text-sm my-1 text-purple-400">${message.substring(1)}</p>`;
            }

            consoleElement.innerHTML += logMessage;
            consoleElement.scrollTop = consoleElement.scrollHeight;
        }
        
        // --- INITIALIZATION & GAME START ---

        function pickRandomStat(statList) {
            const totalRarity = statList.reduce((sum, s) => sum + s.rarity, 0);
            let rand = Math.random() * totalRarity;
            for (const stat of statList) {
                if (rand < stat.rarity) {
                    return stat;
                }
                rand -= stat.rarity;
            }
            return statList[0]; // Fallback
        }

        function generateInitialStats(state) {
            const root = pickRandomStat(SPIRIT_ROOTS);
            const bone = pickRandomStat(BONE_QUALITIES);

            state.spiritRoot = root.multiplier;
            state.spiritRootName = root.name;
            state.boneQuality = bone.multiplier;
            state.boneQualityName = bone.name;
            
            // Removed: state.cultivationMethod = ['Thái Huyền Kiếm Quyết', 'Vạn Pháp Quy Nguyên Công', 'Huyết Sát Ma Kinh'][Math.floor(Math.random() * 3)];
            return state;
        }
        
        // Main function to start the game
        window.onload = function() {
            window.startGame();
        };

        window.startGame = function() {
            const loadedState = window.loadGame();
            
            if (loadedState) {
                gameState = { ...initialGameState, ...loadedState }; 
                gameState.npcInteractions = gameState.npcInteractions || initialGameState.npcInteractions;
                gameState.currentDay = gameState.currentDay || 1;
                gameState.lastAuctionDay = gameState.lastAuctionDay || 0;
                // NEW: Ensure new cultivation state variables exist on old saves
                gameState.knownCultivationMethods = gameState.knownCultivationMethods || [];
                gameState.activeCultivationMethod = gameState.activeCultivationMethod || null;
                
                logToConsole(`§TẢI THÀNH CÔNG: Tiếp tục hành trình từ Cảnh Giới ${REALMS[gameState.realmIndex].name}.`);
            } else {
                gameState = generateInitialStats({ ...initialGameState });
                logToConsole("§KHỞI TẠO MỚI: Không tìm thấy dữ liệu lưu. Bắt đầu hành trình mới.");
                logToConsole(`§TẠO NHÂN VẬT: Linh Căn của bạn là **${gameState.spiritRootName}** (x${gameState.spiritRoot})!`);
                logToConsole(`§TẠO NHÂN VẬT: Căn Cốt của bạn là **${gameState.boneQualityName}** (x${gameState.boneQuality})!`);
                window.saveGame(gameState); 
            }
            
            // Generate daily item if missing (e.g. first load of the day)
            if (!gameState.dailyItem || (gameState.currentDay !== 1 && !SPECIAL_ITEMS.find(i => i.name === gameState.dailyItem.name))) {
                 generateDailySpecialItem();
            }

            finalizeInit();
        }

        function finalizeInit() {
            if (tuXianInterval) clearInterval(tuXianInterval);
            if (combatInterval) clearInterval(combatInterval);
            if (npcCombatInterval) clearInterval(npcCombatInterval);
            if (healthRegenInterval) clearInterval(healthRegenInterval);
            if (timeTickInterval) clearInterval(timeTickInterval);
            
            calculateStats();
            updateUI();
            startTuoXianLoop();
            startRegenLoop(); 
            startTimeTick();
            switchView(gameState.currentView || 'TuoXian');
        }

        function calculateStats() {
            const currentRealm = REALMS[gameState.realmIndex];
            const boneStat = BONE_QUALITIES.find(b => b.name === gameState.boneQualityName);
            const rootStat = SPIRIT_ROOTS.find(r => r.name === gameState.spiritRootName);
            
            // HP
            gameState.maxHP = 100 + (gameState.realmIndex * 250) + (boneStat?.hpBonus || 1) * 100;
            gameState.currentHP = Math.min(gameState.currentHP, gameState.maxHP);

            // MP
            gameState.maxMP = 50 + (gameState.realmIndex * 100) + (rootStat?.mpBonus || 1) * 50;
            gameState.currentMP = Math.min(gameState.currentMP, gameState.maxMP);
            gameState.mpRegenRate = (rootStat?.mpRegen || 1) * 2; // Base 2 MP/tick

            // ATK/DEF: Realm Base + Method/Bone Bonus
            gameState.baseAttack = currentRealm.baseDmg + Math.floor(gameState.realmIndex * 15);
            gameState.baseDefense = currentRealm.baseDef + Math.floor(gameState.realmIndex * 10);
            
            // Apply Method Bonus (simplified) - UPDATED LOGIC
            if (gameState.activeCultivationMethod) { 
                if (gameState.activeCultivationMethod.includes('Kiếm Quyết')) gameState.baseAttack += 10;
                if (gameState.activeCultivationMethod.includes('Quy Nguyên')) gameState.baseDefense += 10;
                // Áp dụng cho Công pháp Đấu Giá (Huyết Sát Ma Kinh)
                if (gameState.activeCultivationMethod.includes('Huyết Sát Ma Kinh')) {
                    gameState.baseAttack += 20;
                    gameState.baseDefense -= 10; // Giảm phòng thủ
                }
            }
            
            updateUI();
        }

        function updateUI() {
            const currentRealm = REALMS[gameState.realmIndex];
            const nextRealmMaxExp = currentRealm.maxExp;
            const currentExp = gameState.experience;
            const boneStat = BONE_QUALITIES.find(b => b.name === gameState.boneQualityName);

            // Time Display
            const currentMonth = Math.floor(gameState.currentDay / 30) + 1;
            const dayInMonth = (gameState.currentDay % 30) || 30;
            document.getElementById('time-display').textContent = `Ngày: ${dayInMonth} | Tháng: ${currentMonth}`;

            // Stats Panel Updates
            document.getElementById('stat-realm').textContent = currentRealm.name;
            document.getElementById('stat-method').textContent = gameState.activeCultivationMethod || "Chưa học"; // UPDATED LINE
            document.getElementById('stat-money').textContent = gameState.spiritStone.toLocaleString();
            document.getElementById('stat-spirit-root').textContent = `${gameState.spiritRootName} (x${gameState.spiritRoot})`;
            document.getElementById('stat-bone').textContent = `${gameState.boneQualityName} (HP x${boneStat?.hpBonus || 1})`;

            document.getElementById('stat-attack').textContent = gameState.baseAttack;
            document.getElementById('stat-defense').textContent = gameState.baseDefense;
            document.getElementById('stat-hp').textContent = `${gameState.currentHP.toFixed(0)} / ${gameState.maxHP.toFixed(0)}`;
            document.getElementById('stat-mp').textContent = `${gameState.currentMP.toFixed(0)} / ${gameState.maxMP.toFixed(0)} (Hồi: +${gameState.mpRegenRate}/tick)`;

            // Progress Bars
            const expProgress = Math.min(100, (currentExp / nextRealmMaxExp) * 100);
            document.getElementById('stat-exp').textContent = `${currentExp.toLocaleString()} / ${nextRealmMaxExp.toLocaleString()}`;
            document.getElementById('exp-progress').style.width = `${expProgress}%`;
            
            const hpProgress = (gameState.currentHP / gameState.maxHP) * 100;
            document.getElementById('hp-progress').style.width = `${hpProgress}%`;

            const mpProgress = (gameState.currentMP / gameState.maxMP) * 100;
            document.getElementById('mp-progress').style.width = `${mpProgress}%`;

            // Rerender combat/trade specific UI if needed
            if (gameState.currentView === 'Combat' && (gameState.currentMonster || gameState.currentNPCCombat)) {
                renderView('Combat');
            } else if (gameState.currentView === 'Trade') {
                renderView('Trade');
            } else if (gameState.currentView === 'NPC') {
                renderView('NPC');
            }
        }

        // --- TIME AND REGEN LOOPS ---

        function startTimeTick() {
            if (timeTickInterval) clearInterval(timeTickInterval);
            timeTickInterval = setInterval(gameTick, GAME_TICK_INTERVAL);
        }

        function gameTick() {
            gameTicks++;

            // MP Regen
            if (gameState.currentMP < gameState.maxMP) {
                gameState.currentMP = Math.min(gameState.maxMP, gameState.currentMP + gameState.mpRegenRate);
            }

            // Day Change
            if (gameTicks % DAY_DURATION_TICKS === 0) {
                gameState.currentDay++;
                logToConsole(`!NHẬT KÝ: Hôm nay là Ngày ${gameState.currentDay % 30 || 30} (Tháng ${Math.floor(gameState.currentDay / 30) + 1}).`);
                
                // Monthly Auction Check (Day 30 of the month, and only once per month)
                if (gameState.currentDay % 30 === 0 && gameState.currentDay > gameState.lastAuctionDay) {
                    startMonthlyAuction();
                }

                // Generate new Daily Shop Item
                generateDailySpecialItem();
            }

            updateUI();
        }

        function startRegenLoop() {
            if (healthRegenInterval) clearInterval(healthRegenInterval);
            healthRegenInterval = setInterval(() => {
                // Chỉ hồi phục khi không chiến đấu và HP chưa đầy
                if (gameState.currentHP < gameState.maxHP && !combatInterval && !npcCombatInterval) {
                    const boneStat = BONE_QUALITIES.find(b => b.name === gameState.boneQualityName);
                    const healRate = 0.05 * (boneStat?.multiplier || 1.0);
                    const heal = Math.ceil(gameState.maxHP * healRate);
                    gameState.currentHP = Math.min(gameState.maxHP, gameState.currentHP + heal);
                    updateUI();
                }
            }, 5000);
        }

        // --- SHOP & AUCTION ---

        function generateDailySpecialItem() {
            const availableItems = SPECIAL_ITEMS;
            gameState.dailyItem = availableItems[Math.floor(Math.random() * availableItems.length)];
            logToConsole(`!THƯƠNG HỘI: Vật phẩm Đặc Biệt Hôm Nay là **${gameState.dailyItem.name}**.`);
        }

        function startMonthlyAuction() {
            gameState.lastAuctionDay = gameState.currentDay;
            const auctionItem = AUCTION_ITEMS[Math.floor(Math.random() * AUCTION_ITEMS.length)];
            const finalPrice = auctionItem.basePrice + Math.floor(Math.random() * auctionItem.basePrice * 0.2); // +20%
            gameState.auctionItem = { ...auctionItem, currentPrice: finalPrice };
            logToConsole(`§ĐẤU GIÁ HÀNG THÁNG: Vật phẩm Đấu Giá là **${auctionItem.name}** với giá khởi điểm ${finalPrice.toLocaleString()} Linh Thạch!`);
        }

        window.buyDailyItem = function() {
            const item = gameState.dailyItem;
            if (!item) return logToConsole("XShop hôm nay không có vật phẩm đặc biệt.");
            if (gameState.spiritStone < item.price) return logToConsole("XBạn không đủ Linh Thạch để mua.");
            
            gameState.spiritStone -= item.price;

            if (item.type === 'mp') {
                gameState.currentMP = Math.min(gameState.maxMP, gameState.currentMP + item.bonus);
                logToConsole(`•Dùng ${item.name}! Hồi ${item.bonus} Linh Khí.`);
            } else if (item.type === 'hp') {
                const currentBone = BONE_QUALITIES.find(b => b.name === gameState.boneQualityName);
                if (currentBone) currentBone.hpBonus += item.bonus;
                logToConsole(`•Dùng ${item.name}! Max HP vĩnh viễn tăng thêm.`);
            } else if (item.type === 'atk') {
                gameState.baseAttack += item.bonus;
                logToConsole(`•Dùng ${item.name}! Tấn Công vĩnh viễn tăng ${item.bonus}.`);
            }

            gameState.dailyItem = null; // Mark as sold for the day
            calculateStats();
            window.saveGame(gameState);
        }

        window.buyAuctionItem = function() {
            const item = gameState.auctionItem;
            if (!item) return logToConsole("XHiện không có vật phẩm đấu giá nào.");
            if (gameState.currentDay % 30 !== 0) return logToConsole("XBạn chỉ có thể mua vật phẩm đấu giá vào Ngày 30.");
            if (gameState.spiritStone < item.currentPrice) return logToConsole("XBạn không đủ Linh Thạch để thắng đấu giá.");
            
            gameState.spiritStone -= item.currentPrice;

            if (item.type === 'bone_change') {
                const newBone = pickRandomStat(BONE_QUALITIES);
                gameState.boneQualityName = newBone.name;
                gameState.boneQuality = newBone.multiplier;
                logToConsole(`§THẮNG ĐẤU GIÁ! Cải Cốt Đan đã biến đổi Căn Cốt của bạn thành **${newBone.name}**!`);
            } else if (item.type === 'root_change') {
                const newRoot = pickRandomStat(SPIRIT_ROOTS);
                gameState.spiritRootName = newRoot.name;
                gameState.spiritRoot = newRoot.multiplier;
                logToConsole(`§THẮNG ĐẤU GIÁ! Tẩy Tủy Đan đã biến đổi Linh Căn của bạn thành **${newRoot.name}**!`);
            } else if (item.type === 'atk_mega') {
                gameState.baseAttack += item.bonus;
                logToConsole(`§THẮNG ĐẤU GIÁ! Tấn Công của bạn tăng thêm ${item.bonus} điểm vĩnh viễn.`);
            } else if (item.type === 'cultivation_method') { // NEW LOGIC FOR CULTIVATION METHOD
                if (!gameState.knownCultivationMethods.includes(item.name)) {
                     gameState.knownCultivationMethods.push(item.name);
                     gameState.activeCultivationMethod = item.name;
                     logToConsole(`§THẮNG ĐẤU GIÁ! Bạn đã học và bắt đầu luyện **${item.name}**!`);
                } else {
                     logToConsole(`§THẮNG ĐẤU GIÁ! Bạn đã có **${item.name}**, nhận thêm 10000 Tu Vi.`);
                     gameState.experience += 10000;
                }
            }
            
            delete gameState.auctionItem;
            calculateStats();
            window.saveGame(gameState);
            renderView('Trade');
        }

        // --- CẢNH GIỚI AND TU VI (Unchanged) ---

        function checkExpCap() {
            const currentRealm = REALMS[gameState.realmIndex];
            if (gameState.realmIndex < REALMS.length - 1 && gameState.experience >= currentRealm.maxExp) {
                gameState.experience = currentRealm.maxExp;
                logToConsole("§TỊCH THUẬN: Tu Vi đã viên mãn. Hãy ĐỘT PHÁ ngay!");
            }
        }

        function getBreakthroughSuccessRate() {
            if (gameState.realmIndex >= REALMS.length - 1) return 0; // Max realm
            
            const boneStat = BONE_QUALITIES.find(b => b.name === gameState.boneQualityName);
            let rate = 0.5; // Base 50%
            
            rate += (gameState.realmIndex * 0.05); // +5% per realmIndex
            rate += (boneStat?.breakthroughBonus || 0);
            
            // Check for Trúc Cơ Đan
            if (gameState.inventory['Trúc Cơ Đan'] > 0) {
                rate = 1.0; // 100% success
            }

            return Math.min(1.0, Math.max(0.01, rate)); // Clamp between 1% and 100%
        }

        window.breakthrough = function() {
            const currentRealm = REALMS[gameState.realmIndex];
            const nextRealm = REALMS[gameState.realmIndex + 1];
            
            if (gameState.experience < currentRealm.maxExp) {
                return logToConsole("XTU VI: Tu vi chưa viên mãn! Hãy tiếp tục Tọa Thiền.");
            }
            if (gameState.currentHP < gameState.maxHP * 0.5) {
                return logToConsole("XTHƯƠNG TÍCH: HP thấp quá, dễ Tẩu Hỏa Nhập Ma! Hãy hồi phục đã.");
            }
            if (gameState.realmIndex >= REALMS.length - 1) {
                return logToConsole("§ĐẠO CỰC: Bạn đã đạt đến Cảnh Giới tối cao. Không thể Đột Phá nữa.");
            }

            const successRate = getBreakthroughSuccessRate();
            const hasPill = gameState.inventory['Trúc Cơ Đan'] > 0;
            
            logToConsole(`!ĐỘT PHÁ: Đang chuẩn bị đột phá từ ${currentRealm.name} lên ${nextRealm.name}... Tỉ lệ thành công: ${(successRate * 100).toFixed(0)}%`);

            // Always consume Trúc Cơ Đan if used
            if (hasPill) {
                gameState.inventory['Trúc Cơ Đan']--;
                logToConsole("•Dùng Trúc Cơ Đan, đảm bảo đột phá thành công!");
            }

            if (hasPill || Math.random() < successRate) {
                // Success
                gameState.realmIndex++;
                gameState.experience = 0; // Reset exp
                gameState.currentHP = gameState.maxHP; // Full heal
                gameState.currentMP = gameState.maxMP; // Full MP
                logToConsole(`§CHÚC MỪNG! Đột phá thành công lên **${nextRealm.name}**! Chỉ số được tăng cường.`);
            } else {
                // Failure
                logToConsole("XTHẤT BẠI: Đột phá thất bại! Bạn bị Tẩu Hỏa Nhập Ma.");
                gameState.experience = Math.floor(currentRealm.maxExp * 0.8); // Lose 20% max exp
                gameState.currentHP = Math.floor(gameState.maxHP * 0.3); // Severe damage
                if (gameState.currentHP <= 0) gameState.currentHP = 1; 
            }

            calculateStats(); // Recalculate based on new realm
            window.saveGame(gameState);
        }

        // --- TU XIAN (Tọa Thiền) ---

        function startTuoXianLoop() {
            if (tuXianInterval) clearInterval(tuXianInterval);
            tuXianInterval = setInterval(tuoXianTick, GAME_TICK_INTERVAL);
        }

        function tuoXianTick() {
            const currentRealm = REALMS[gameState.realmIndex];
            const rootStat = SPIRIT_ROOTS.find(r => r.name === gameState.spiritRootName);
            
            // Base gain + multiplier from Spirit Root
            const baseGain = 10;
            const expGain = Math.floor(baseGain * gameState.spiritRoot);

            gameState.experience += expGain;

            checkExpCap();
            updateUI();
        }

        // --- COMBAT & MONSTER HUNTING (Unchanged) ---

        function generateMonster() {
            const realmIndex = gameState.realmIndex;
            // Only consider monsters up to the player's current realm
            const availableMonsters = MONSTERS.filter(m => m.minRealm <= realmIndex + 1); 

            if (availableMonsters.length === 0) {
                 return MONSTERS[0]; // Fallback to easiest monster
            }
            
            const monster = availableMonsters[Math.floor(Math.random() * availableMonsters.length)];
            
            // Scale monster stats based on player realm relative to monster minRealm
            const powerDifference = realmIndex - monster.minRealm;
            const scalingFactor = 1 + (powerDifference > 0 ? powerDifference * 0.1 : 0); // 10% increase per realm above monster's min

            const finalHp = Math.ceil(monster.baseHp * scalingFactor);
            const finalAtk = Math.ceil(monster.baseAtk * scalingFactor);

            return { 
                ...monster, 
                currentHP: finalHp, 
                maxHP: finalHp,
                currentATK: finalAtk
            };
        }

        window.startCombat = function() {
            if (gameState.currentMonster) return logToConsole("XĐANG CHIẾN ĐẤU: Bạn đang bị bủa vây!");
            if (gameState.currentHP <= 0) return logToConsole("XTHƯƠNG TÍCH: Không thể chiến đấu khi đã gục ngã.");

            const monster = generateMonster();
            gameState.currentMonster = monster;
            logToConsole(`!GẶP ĐỊCH: ${monster.name} xuất hiện!`);
            
            switchView('Combat');
            if (combatInterval) clearInterval(combatInterval);
            combatInterval = setInterval(combatTick, 1000);
        }

        function combatTick() {
            if (!gameState.currentMonster || gameState.currentHP <= 0) {
                endCombat();
                return;
            }

            // Player Attack (Base Attack)
            const playerDmg = Math.max(1, gameState.baseAttack - Math.floor(gameState.currentMonster.currentATK * 0.1)); // Monster DEF is 10% ATK
            gameState.currentMonster.currentHP -= playerDmg;
            logToConsole(`•Bạn tấn công ${gameState.currentMonster.name}, gây ${playerDmg.toFixed(0)} sát thương.`);

            if (gameState.currentMonster.currentHP <= 0) {
                handleMonsterDefeated(gameState.currentMonster);
                endCombat();
                return;
            }

            // Monster Attack
            const monsterDmg = Math.max(1, gameState.currentMonster.currentATK - gameState.baseDefense);
            gameState.currentHP -= monsterDmg;
            logToConsole(`X${gameState.currentMonster.name} phản công, bạn chịu ${monsterDmg.toFixed(0)} sát thương.`);

            if (gameState.currentHP <= 0) {
                handlePlayerDefeated();
                endCombat();
                return;
            }

            updateUI();
        }

        function endCombat() {
            if (combatInterval) clearInterval(combatInterval);
            gameState.currentMonster = null;
            renderView('Combat'); // Re-render to show Hunting buttons
            updateUI();
            window.saveGame(gameState);
        }

        function handleMonsterDefeated(monster) {
            const expGain = monster.exp;
            gameState.experience += expGain;
            gameState.spiritStone += 50; // Base money drop

            logToConsole(`§CHIẾN THẮNG! Hạ gục ${monster.name}, nhận ${expGain.toLocaleString()} Tu Vi và 50 Linh Thạch.`);
            
            // Handle Loot Drop
            for (const [item, rate] of Object.entries(monster.loot)) {
                if (Math.random() < rate) {
                    gameState.inventory[item] = (gameState.inventory[item] || 0) + 1;
                    logToConsole(`•Nhận được vật phẩm: **${item}**.`);
                }
            }

            checkExpCap();
        }

        function handlePlayerDefeated() {
            logToConsole("XTHẤT BẠI: Bạn đã gục ngã. Trở về tông môn để hồi phục.");
            gameState.currentHP = 1; // Always leave 1 HP
            gameState.spiritStone = Math.max(0, gameState.spiritStone - 100); // Small penalty
            gameState.experience = Math.floor(gameState.experience * 0.95); // Lose 5% exp
        }

        // --- TRADE & INVENTORY VIEWS ---

        window.renderInventoryView = function() {
            let inventoryHTML = `
                <h3 class="text-2xl text-center mb-4 text-green-400 border-b border-gray-600 pb-2">TÚI TRỮ VẬT (INVENTORY)</h3>
                <div class="space-y-4">
            `;
            const inventoryItems = Object.keys(gameState.inventory).filter(key => gameState.inventory[key] > 0);
            const commonItems = inventoryItems.filter(key => LOOT_PRICES[key]?.type === 'common');
            const rareItems = inventoryItems.filter(key => LOOT_PRICES[key]?.type !== 'common');

            let sellLootHTML = commonItems.map(itemName => `
                <div class="flex justify-between items-center my-2 pixel-card bg-gray-700">
                    <p class="text-xl">${itemName}: <span class="text-yellow-300">${gameState.inventory[itemName]}x</span></p>
                    <div class="flex space-x-2">
                         <button class="game-button text-xs p-1" onclick="sellLoot('${itemName}', 1)">Bán Nhanh (${(LOOT_PRICES[itemName]?.price || 0).toLocaleString()} LT)</button>
                    </div>
                </div>
            `).join('');

            inventoryHTML += `
                <div class="pixel-card bg-gray-800 p-3">
                    <p class="text-xl mb-2 text-yellow-300">Công Pháp Đã Học:</p>
                    <p class="text-lg text-green-400">${gameState.knownCultivationMethods.join(', ') || 'Chưa có công pháp.'}</p>
                </div>
                ${inventoryItems.length > 0 ? `
                    <h4 class="text-xl text-yellow-300 border-b border-gray-600">VẬT PHẨM THU HOẠCH</h4>
                    <p class="text-sm text-gray-400">Có thể bán tại Thương Hội hoặc dùng (nếu là Đan Dược).</p>
                    <div class="space-y-3">
                        ${commonItems.length > 0 ? `<p class="text-base text-green-300 mt-2 mb-1">--- Vật Phẩm Phổ Thông ---</p>` : ''}
                        ${sellLootHTML}
                        
                        ${rareItems.length > 0 ? `<p class="text-base text-red-400 mt-4 mb-1">--- BẢO VẬT HIẾM (Giá Cao) ---</p>` : ''}
                        ${inventoryItems.filter(key => LOOT_PRICES[key]?.type === 'rare' || LOOT_PRICES[key]?.type === 'super_rare').map(itemName => `
                            <div class="flex justify-between items-center my-2 pixel-card bg-red-800 border-red-500">
                                <p class="text-xl text-red-300 font-bold">${itemName} HIẾM: <span class="text-yellow-100">${gameState.inventory[itemName]}x</span></p>
                                <div class="flex space-x-2">
                                     <button class="game-button text-xs p-1 bg-yellow-600 border-yellow-300 hover:bg-yellow-700" onclick="sellLoot('${itemName}', 1)">Bán Nhanh (${(LOOT_PRICES[itemName]?.price || 0).toLocaleString()} LT)</button>
                                </div>
                            </div>
                        `).join('')}
                        
                    </div>
                ` : '<p class="text-center text-lg pixel-card bg-gray-700 mt-2 text-gray-400">Túi trữ vật rỗng.</p>'}
                </div>
            `;
            document.getElementById('main-content').innerHTML = inventoryHTML;
        }

        window.sellLoot = function(itemName, count) {
            const price = LOOT_PRICES[itemName]?.price || 0;
            if (gameState.inventory[itemName] < count) return logToConsole(`XKhông đủ ${itemName} để bán.`);

            gameState.inventory[itemName] -= count;
            gameState.spiritStone += price * count;

            logToConsole(`•Bán ${count}x **${itemName}**, nhận ${(price * count).toLocaleString()} Linh Thạch.`);
            window.saveGame(gameState);
            renderView('Trade'); // Re-render to show updated inventory and money
        }

        window.buyItem = function(itemName) {
            const item = TRADE_ITEMS.find(i => i.name === itemName);
            if (!item) return logToConsole("XVật phẩm này không có sẵn.");
            if (gameState.spiritStone < item.price) return logToConsole("XBạn không đủ Linh Thạch để mua.");
            
            gameState.spiritStone -= item.price;

            if (item.type === 'exp') {
                gameState.experience += item.bonus;
                logToConsole(`•Dùng ${item.name}! Tăng ${item.bonus.toLocaleString()} Tu Vi.`);
            } else if (item.type === 'def') {
                gameState.baseDefense += item.bonus;
                logToConsole(`•Dùng ${item.name}! Phòng Thủ vĩnh viễn tăng ${item.bonus}.`);
            } else if (item.type === 'breakthrough') {
                 gameState.inventory[item.name] = (gameState.inventory[item.name] || 0) + 1;
                 logToConsole(`•Mua ${item.name}! Vật phẩm đã được thêm vào Túi Trữ Vật.`);
            }
            
            calculateStats();
            window.saveGame(gameState);
            renderView('Trade');
        }

        // UPDATED renderTradeView to include Tàng Kinh Các
        window.renderTradeView = function() {
            // --- INVENTORY HTML ---
            const inventoryItems = Object.keys(gameState.inventory).filter(key => gameState.inventory[key] > 0);
            const sellLootHTML = inventoryItems.map(itemName => {
                const price = LOOT_PRICES[itemName]?.price || 0;
                return `
                    <div class="flex justify-between items-center my-2 pixel-card bg-gray-700">
                        <p class="text-sm text-gray-300">${itemName}: <span class="text-yellow-300">${gameState.inventory[itemName]}x</span></p>
                        <button class="game-button text-xs p-1" onclick="sellLoot('${itemName}', 1)">Bán (${price.toLocaleString()} LT)</button>
                    </div>
                `;
            }).join('');

            // --- DAILY ITEM HTML ---
            const dailyItemHTML = gameState.dailyItem ? `
                <div class="pixel-card bg-yellow-900 border-yellow-400 p-3 mb-4">
                    <p class="text-xl text-yellow-300 font-bold mb-2">Đặc Biệt Hôm Nay: ${gameState.dailyItem.name} (${gameState.dailyItem.price.toLocaleString()} LT)</p>
                    <p class="text-sm text-gray-300 mb-2">${gameState.dailyItem.description}</p>
                    <button class="game-button w-full p-2" ${gameState.spiritStone < gameState.dailyItem.price ? 'disabled' : ''} onclick="buyDailyItem()">MUA NGAY</button>
                </div>
            ` : `<p class="text-center text-lg pixel-card bg-gray-700 mt-2 text-gray-400">Vật phẩm đặc biệt đã bán hết.</p>`;
            
            // --- AUCTION ITEM HTML ---
            const auctionItemHTML = gameState.auctionItem ? `
                <div class="pixel-card bg-red-900 border-red-500 p-3 mb-4">
                    <p class="text-xl text-red-300 font-bold mb-2">Vật Phẩm Đấu Giá: ${gameState.auctionItem.name}</p>
                    <p class="text-base text-yellow-100 mb-2">Giá Đấu Thầu: ${gameState.auctionItem.currentPrice.toLocaleString()} LT (Ngày ${gameState.currentDay % 30 || 30})</p>
                    <p class="text-sm text-gray-300 mb-2">${gameState.auctionItem.description}</p>
                    <button class="game-button w-full p-2" ${gameState.currentDay % 30 !== 0 || gameState.spiritStone < gameState.auctionItem.currentPrice ? 'disabled' : ''} onclick="buyAuctionItem()">ĐẤU THẦU (Chỉ vào Ngày 30)</button>
                </div>
            ` : `<p class="text-center text-lg pixel-card bg-gray-700 mt-2 text-gray-400">Chưa có bảo vật đấu giá. (Chờ Ngày 30)</p>`;


            // --- TÀNG KINH CÁC (SECT LIBRARY) --- //
            const libraryMethods = CULTIVATION_METHODS; // All regular methods are here
            
            let libraryHTML = `
                <h3 class="text-2xl text-center mt-4 text-green-400 border-b border-gray-600 pb-2">TÀNG KINH CÁC (TRONG TÔNG MÔN)</h3>
                <p class="text-sm text-gray-400 mb-2">Học Công Pháp để tăng sức mạnh cơ bản. Học xong có thể chuyển đổi công pháp.</p>
                <div class="space-y-3">
                    ${libraryMethods.map(method => {
                        const isKnown = gameState.knownCultivationMethods.includes(method.name);
                        const isActive = gameState.activeCultivationMethod === method.name;
                        
                        let buttonHTML;
                        if (isActive) {
                            buttonHTML = `<span class="text-xs p-1 bg-green-900 border-green-500 text-green-300">Đang Luyện</span>`;
                        } else if (isKnown) {
                            buttonHTML = `<button class="game-button text-xs p-1 bg-yellow-600 border-yellow-300 hover:bg-yellow-700" onclick="learnCultivationMethod('${method.name}')">CHUYỂN ĐỔI</button>`;
                        } else {
                            buttonHTML = `<button class="game-button text-xs p-1" ${method.price > gameState.spiritStone ? 'disabled' : ''} onclick="learnCultivationMethod('${method.name}')">HỌC (${method.price.toLocaleString()} LT)</button>`;
                        }

                        return `
                            <div class="flex justify-between items-center my-2 pixel-card ${isActive ? 'bg-green-800 border-green-500' : 'bg-gray-700'}">
                                <div>
                                    <p>${method.name} <span class="text-yellow-300">${method.price > 0 ? `(${method.price.toLocaleString()} LT)` : '(Mặc Định)'}</span></p>
                                    <p class="text-xs text-gray-400">${method.description}</p>
                                </div>
                                ${buttonHTML}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            const tradeItemsHTML = TRADE_ITEMS.map(item => `
                <div class="flex justify-between items-center my-2 pixel-card bg-gray-700">
                    <div>
                        <p>${item.name} <span class="text-yellow-300">(${item.price.toLocaleString()} LT)</span></p>
                        <p class="text-xs text-gray-400">${item.description}</p>
                    </div>
                    <button class="game-button text-xs p-1" onclick="buyItem('${item.name}')">MUA</button>
                </div>
            `).join('');


            let tradeHTML = `
                <div>
                    ${libraryHTML} <h3 class="text-2xl text-center mt-6 text-yellow-300 border-b border-gray-600 pb-2">THƯƠNG HỘI TỔNG QUAN</h3>
                    
                    ${dailyItemHTML}

                    <h3 class="text-2xl text-center mt-4 text-cyan-400 border-b border-gray-600 pb-2">VẬT PHẨM THƯỜNG TRỰC</h3>
                    <div class="space-y-3">
                    ${tradeItemsHTML}
                    </div>

                    <h3 class="text-2xl text-center mt-4 text-red-400 border-b border-gray-600 pb-2">KHU VỰC ĐẤU GIÁ</h3>
                    ${auctionItemHTML}
                    
                    <h3 class="text-2xl text-center mt-4 text-yellow-400 border-b border-gray-600 pb-2">TÚI TRỮ VẬT ĐỂ BÁN</h3>
                    <div class="space-y-3">
                    ${inventoryItems.length > 0 ? sellLootHTML : `<p class="text-center text-lg pixel-card bg-gray-700 mt-2 text-gray-400">Không có vật phẩm để bán.</p>`}
                    </div>
                </div>
            `;

            document.getElementById('main-content').innerHTML = tradeHTML;
        }

        // --- CULTIVATION METHOD FUNCTIONS (NEW) ---
        window.learnCultivationMethod = function(methodName) {
            // Find method in both regular list and auction list (only for known methods if checking state)
            const method = CULTIVATION_METHODS.find(m => m.name === methodName) || AUCTION_ITEMS.find(m => m.name === methodName && m.type === 'cultivation_method');
            if (!method) return logToConsole("XCông pháp này không tồn tại.");
            
            // 1. Check if already learned (and switch/activate)
            if (gameState.knownCultivationMethods.includes(methodName)) {
                // If already active, do nothing
                if (gameState.activeCultivationMethod === methodName) {
                    return logToConsole(`XBạn đã và đang luyện **${methodName}** rồi.`);
                }
                
                gameState.activeCultivationMethod = methodName;
                logToConsole(`•THÀNH CÔNG: Bạn đã chuyển sang luyện **${methodName}**.`);
            } 
            // 2. Learning (buying) the method from Tàng Kinh Các
            else {
                if (gameState.spiritStone < method.price) return logToConsole(`XBạn không đủ ${method.price.toLocaleString()} Linh Thạch để học **${methodName}**.`);
                
                gameState.spiritStone -= method.price;
                gameState.knownCultivationMethods.push(methodName);
                gameState.activeCultivationMethod = methodName; // Auto activate upon learning
                logToConsole(`§CHÚC MỪNG! Bạn đã học và bắt đầu luyện **${methodName}**!`);
            }

            calculateStats();
            renderView('Trade'); 
            window.saveGame(gameState);
        }
        
        // --- NPC LOGIC (Unchanged) ---

        window.renderNPCView = function() {
            let npcHTML = `
                <h3 class="text-2xl text-center mb-4 text-cyan-400 border-b border-gray-600 pb-2">GIAO TIẾP VỚI NPC</h3>
                <div class="space-y-4">
            `;

            npcHTML += MOCK_NPCS.map(npc => {
                let challengeButton = '';
                if (npc.isChallengable) {
                    challengeButton = `<button class="game-button text-xs p-1 bg-red-600 border-red-300 hover:bg-red-700" onclick="startNPCCombat('${npc.id}')">THÁCH ĐẤU</button>`;
                }
                
                return `
                    <div class="flex justify-between items-center my-2 pixel-card bg-gray-700">
                        <div>
                            <p class="text-xl text-yellow-300">${npc.name} (${npc.realm})</p>
                            <p class="text-sm text-gray-400">${npc.description}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button class="game-button text-xs p-1" onclick="interactNPC('${npc.id}')">TƯƠNG TÁC</button>
                            ${challengeButton}
                        </div>
                    </div>
                `;
            }).join('');

            npcHTML += '</div>';

            if (gameState.currentNPCCombat) {
                const npc = MOCK_NPCS.find(n => n.id === gameState.currentNPCCombat.id);
                npcHTML += `
                    <h3 class="text-2xl text-center mt-6 text-red-400 border-b border-gray-600 pb-2">ĐANG CHIẾN ĐẤU: ${npc.name}</h3>
                    <div class="pixel-card bg-gray-900 p-3">
                        <p class="text-lg text-yellow-300">HP ${npc.name}: <span id="npc-combat-hp">${gameState.currentNPCCombat.currentHP.toFixed(0)} / ${gameState.currentNPCCombat.maxHP.toFixed(0)}</span></p>
                        <div class="progress-bar-monster-hp mt-1">
                            <div id="npc-combat-hp-progress" class="progress-fill-monster-hp" style="width: ${((gameState.currentNPCCombat.currentHP / gameState.currentNPCCombat.maxHP) * 100).toFixed(0)}%"></div>
                        </div>
                        <p class="text-lg text-red-400 mt-2">HP Bạn: ${gameState.currentHP.toFixed(0)} / ${gameState.maxHP.toFixed(0)}</p>
                        <p class="text-lg text-purple-400">MP Bạn: ${gameState.currentMP.toFixed(0)} / ${gameState.maxMP.toFixed(0)}</p>
                        
                        <div class="mt-4 flex space-x-2">
                            ${SKILLS.map(skill => `
                                <button class="game-button text-sm p-2 bg-blue-600 border-blue-300 hover:bg-blue-700" onclick="useSkillNPCCombat('${skill.name}')" ${gameState.currentMP < skill.mpCost ? 'disabled' : ''}>
                                    ${skill.name} (-${skill.mpCost} MP)
                                </button>
                            `).join('')}
                            <button class="game-button text-sm p-2 bg-gray-600 border-gray-300 hover:bg-gray-700" onclick="runFromNPCCombat()">CHẠY TRỐN</button>
                        </div>
                    </div>
                `;
            }

            document.getElementById('main-content').innerHTML = npcHTML;
        }

        function interactNPC(npcId) {
            const npc = MOCK_NPCS.find(n => n.id === npcId);
            
            if (npcId === 'thanhvan') {
                if (!gameState.npcInteractions.thanhvan_advice_atk) {
                    gameState.baseAttack += 50;
                    gameState.npcInteractions.thanhvan_advice_atk = true;
                    logToConsole("§TƯƠNG TÁC: Sư Tỷ Thanh Vân hài lòng, chỉ điểm bạn 50 Tấn Công cơ bản.");
                } else {
                    logToConsole("!TƯƠNG TÁC: Sư Tỷ Thanh Vân mỉm cười, bảo bạn nên tự lực tu luyện.");
                }
            } else if (npcId === 'sugia') {
                if (!gameState.npcInteractions.sugia_advice_def) {
                    gameState.baseDefense += 50;
                    gameState.npcInteractions.sugia_advice_def = true;
                    logToConsole("§TƯƠNG TÁC: Sư Già Tiền Bối gật đầu, truyền thụ 50 Phòng Thủ cơ bản.");
                } else {
                    logToConsole("!TƯƠNG TÁC: Sư Già Tiền Bối chỉ vào Tàng Kinh Các, ngụ ý bạn nên đi học công pháp.");
                }
            } else if (npcId === 'truonglao') {
                logToConsole("!TƯƠNG TÁC: Trưởng Lão Dược Các bảo bạn nên chú ý khu vực Đấu Giá Hội hàng tháng.");
            } else if (npcId === 'thientai') {
                 logToConsole("!TƯƠNG TÁC: Thiên Tài Huyền Băng nhìn bạn với vẻ kiêu ngạo, không nói gì.");
            }

            calculateStats();
            window.saveGame(gameState);
        }

        function startNPCCombat(npcId) {
             const npc = MOCK_NPCS.find(n => n.id === npcId);
             if (!npc) return logToConsole("XNPC này không tồn tại.");
             if (gameState.currentNPCCombat) return logToConsole("XĐANG CHIẾN ĐẤU: Bạn đang bị bủa vây!");
             if (gameState.currentHP <= 0) return logToConsole("XTHƯƠNG TÍCH: Không thể chiến đấu khi đã gục ngã.");

             gameState.currentNPCCombat = { 
                id: npc.id, 
                currentHP: npc.baseHp, 
                maxHP: npc.baseHp,
                currentATK: npc.baseAtk,
                currentDEF: npc.baseDef,
                reward: npc.reward
             };

             logToConsole(`!THÁCH ĐẤU: Bạn bắt đầu chiến đấu với **${npc.name}**!`);
             
             switchView('NPC');
             if (npcCombatInterval) clearInterval(npcCombatInterval);
             npcCombatInterval = setInterval(npcCombatTick, 1500); // Slower combat tick for NPC
        }

        function npcCombatTick() {
            if (!gameState.currentNPCCombat || gameState.currentHP <= 0) {
                endNPCCombat();
                return;
            }
            const npc = MOCK_NPCS.find(n => n.id === gameState.currentNPCCombat.id);

            // Player Attack (Base Attack)
            const playerDmg = Math.max(1, gameState.baseAttack - gameState.currentNPCCombat.currentDEF);
            gameState.currentNPCCombat.currentHP -= playerDmg;
            logToConsole(`•Bạn tấn công ${npc.name}, gây ${playerDmg.toFixed(0)} sát thương.`);

            if (gameState.currentNPCCombat.currentHP <= 0) {
                handleNPCDefeated(npc);
                endNPCCombat();
                return;
            }

            // NPC Attack
            const npcDmg = Math.max(1, gameState.currentNPCCombat.currentATK - gameState.baseDefense);
            gameState.currentHP -= npcDmg;
            logToConsole(`X${npc.name} phản công, bạn chịu ${npcDmg.toFixed(0)} sát thương.`);

            if (gameState.currentHP <= 0) {
                handleNPCPlayerDefeated(npc);
                endNPCCombat();
                return;
            }

            renderView('NPC'); // Re-render the NPC view to update combat stats
            updateUI();
        }

        window.useSkillNPCCombat = function(skillName) {
            if (!gameState.currentNPCCombat) return logToConsole("XBạn không đang chiến đấu.");
            const skill = SKILLS.find(s => s.name === skillName);
            if (!skill) return logToConsole("XKỹ năng này không tồn tại.");
            if (gameState.currentMP < skill.mpCost) return logToConsole("XBạn không đủ Linh Khí để dùng kỹ năng này.");
            
            gameState.currentMP -= skill.mpCost;
            
            const npc = MOCK_NPCS.find(n => n.id === gameState.currentNPCCombat.id);
            const playerDmg = Math.max(1, (gameState.baseAttack * skill.damageMultiplier) - gameState.currentNPCCombat.currentDEF);
            
            gameState.currentNPCCombat.currentHP -= playerDmg;
            logToConsole(`§DÙNG KỸ NĂNG: Bạn dùng **${skill.name}**, gây ${playerDmg.toFixed(0)} sát thương lên ${npc.name}.`);

            if (gameState.currentNPCCombat.currentHP <= 0) {
                handleNPCDefeated(npc);
                endNPCCombat();
                return;
            }

            renderView('NPC');
            updateUI();
        }

        function runFromNPCCombat() {
            logToConsole("!HÀNH ĐỘNG: Bạn rút lui khỏi cuộc chiến.");
            endNPCCombat();
        }


        function endNPCCombat() {
            if (npcCombatInterval) clearInterval(npcCombatInterval);
            gameState.currentNPCCombat = null;
            renderView('NPC'); 
            updateUI();
            window.saveGame(gameState);
        }

        function handleNPCDefeated(npc) {
            gameState.spiritStone += npc.reward;
            logToConsole(`§CHIẾN THẮNG KHỦNG! Hạ gục **${npc.name}**, nhận ${npc.reward.toLocaleString()} Linh Thạch!`);
            // NPC's reward is a one-time thing, but we can allow re-fight for now.
        }

        function handleNPCPlayerDefeated(npc) {
            logToConsole(`XTHẤT BẠI: Bạn bị ${npc.name} đánh bại. Tốn 1 ngày để hồi phục.`);
            gameState.currentHP = 1; // Always leave 1 HP
            gameState.spiritStone = Math.max(0, gameState.spiritStone - Math.floor(npc.reward * 0.1)); // Small penalty
            gameState.experience = Math.floor(gameState.experience * 0.98); // Lose 2% exp
            gameState.currentDay++; // Lose a day
        }

        // --- GENERAL VIEW HANDLING (Unchanged) ---

        window.switchView = function(viewName) {
            gameState.currentView = viewName;

            // Clear all running intervals when switching away from Tọa Thiền/Combat
            if (tuXianInterval) clearInterval(tuXianInterval);
            if (combatInterval) clearInterval(combatInterval);
            if (npcCombatInterval) clearInterval(npcCombatInterval);


            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`tab-${viewName}`).classList.add('active');


            if (viewName === 'TuoXian') {
                renderTuoXianView();
                startTuoXianLoop();
            } else if (viewName === 'Combat') {
                renderCombatView();
            } else if (viewName === 'Trade') {
                renderView('Trade');
            } else if (viewName === 'NPC') {
                renderView('NPC');
            }

            window.saveGame(gameState);
        }

        window.renderView = function(viewName) {
            if (viewName === 'TuoXian') return renderTuoXianView();
            if (viewName === 'Combat') return renderCombatView();
            if (viewName === 'Trade') return renderTradeView();
            if (viewName === 'NPC') return renderNPCView();
            if (viewName === 'Inventory') return renderInventoryView();
        }

        function renderTuoXianView() {
            const currentRealm = REALMS[gameState.realmIndex];
            const nextRealm = REALMS[gameState.realmIndex + 1];

            let tuoXianHTML = `
                <h3 class="text-2xl text-center mb-4 text-yellow-300 border-b border-gray-600 pb-2">KHU VỰC TỌA THIỀN</h3>
                <div class="pixel-card bg-gray-700 p-4">
                    <p class="text-xl text-green-400">Cảnh Giới Hiện Tại: ${currentRealm.name}</p>
                    <p class="text-lg text-blue-400">Tu Vi Tối Đa: ${currentRealm.maxExp.toLocaleString()}</p>
                    <p class="text-lg text-purple-400">Linh Căn: ${gameState.spiritRootName} (x${gameState.spiritRoot})</p>
                </div>
                
                <div class="pixel-card bg-gray-700 p-4 mt-4">
                    <p class="text-xl text-yellow-300 mb-2">Tiến Trình Đột Phá:</p>
                    <p class="text-lg text-gray-400 mb-2">Tỉ lệ thành công: ${(getBreakthroughSuccessRate() * 100).toFixed(0)}%</p>
                    <button class="game-button w-full p-2" onclick="breakthrough()" ${gameState.experience < currentRealm.maxExp ? 'disabled' : ''}>
                        ${gameState.realmIndex >= REALMS.length - 1 ? 'ĐÃ ĐẠT CỰC HẠN' : 'ĐỘT PHÁ CẢNH GIỚI'}
                    </button>
                    <p class="text-xs text-red-400 mt-2 text-center">Yêu cầu: Tu Vi viên mãn và HP > 50% Max HP</p>
                </div>
            `;
            document.getElementById('main-content').innerHTML = tuoXianHTML;
        }

        function renderCombatView() {
            let combatHTML = `
                <h3 class="text-2xl text-center mb-4 text-red-400 border-b border-gray-600 pb-2">KHU VỰC CHIẾN ĐẤU</h3>
            `;

            if (gameState.currentMonster) {
                // Combat in progress
                combatHTML += `
                    <div class="pixel-card bg-gray-900 p-4">
                        <p class="text-xl text-yellow-300 mb-2">Đang chiến đấu với: ${gameState.currentMonster.name}</p>
                        <p class="text-lg text-red-400">HP Kẻ Địch: <span id="monster-combat-hp">${gameState.currentMonster.currentHP.toFixed(0)} / ${gameState.currentMonster.maxHP.toFixed(0)}</span></p>
                        <div class="progress-bar-monster-hp mt-1">
                            <div id="monster-combat-hp-progress" class="progress-fill-monster-hp" style="width: ${((gameState.currentMonster.currentHP / gameState.currentMonster.maxHP) * 100).toFixed(0)}%"></div>
                        </div>
                        <p class="text-lg text-gray-400 mt-2">ATK Kẻ Địch: ${gameState.currentMonster.currentATK}</p>
                        <p class="text-lg text-red-400 mt-2">HP Bạn: ${gameState.currentHP.toFixed(0)} / ${gameState.maxHP.toFixed(0)}</p>
                        <p class="text-lg text-purple-400">MP Bạn: ${gameState.currentMP.toFixed(0)} / ${gameState.maxMP.toFixed(0)}</p>
                        
                        <div class="mt-4 flex space-x-2">
                            ${SKILLS.map(skill => `
                                <button class="game-button text-sm p-2 bg-blue-600 border-blue-300 hover:bg-blue-700" onclick="useSkillNPCCombat('${skill.name}')" ${gameState.currentMP < skill.mpCost ? 'disabled' : ''}>
                                    ${skill.name} (-${skill.mpCost} MP)
                                </button>
                            `).join('')}
                            <button class="game-button text-sm p-2 bg-gray-600 border-gray-300 hover:bg-gray-700" onclick="endCombat()">CHẠY TRỐN</button>
                        </div>
                    </div>
                `;
                // Add MP cost for skills in future
            } else {
                // Hunting buttons
                combatHTML += `
                    <p class="text-xl text-gray-400 text-center mb-4">Chọn mục tiêu để săn bắt yêu thú:</p>
                    <div class="space-y-4">
                        ${MONSTERS.filter(m => m.minRealm <= gameState.realmIndex + 1).map(monster => `
                            <div class="flex justify-between items-center my-2 pixel-card bg-gray-700">
                                <div>
                                    <p class="text-xl text-red-400">${monster.name} (${monster.requiredRealm})</p>
                                    <p class="text-sm text-gray-400">ATK: ${monster.baseAtk}, HP: ${monster.baseHp}, EXP: ${monster.exp}</p>
                                </div>
                                <button class="game-button p-2" onclick="startCombat()">SĂN BẮT</button>
                            </div>
                        `).join('')}
                    </div>
                    <div class="mt-6 text-center">
                        <button class="game-button p-2 bg-purple-600 border-purple-300 hover:bg-purple-700" onclick="renderView('Inventory')">TÚI TRỮ VẬT (KHO ĐỒ)</button>
                    </div>
                `;
            }

            document.getElementById('main-content').innerHTML = combatHTML;
        }

    </script>
</body>
</html>
