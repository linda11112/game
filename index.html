<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thiên Mệnh Chi Tỷ Lý Huynh - Realtime RPG (Offline)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        // --- OFFLINE SAVE FUNCTIONS (LOCAL STORAGE) ---
        
        // Ghi dữ liệu vào Local Storage
        window.saveGame = function(state) {
            try {
                const stateToSave = { ...state };
                // Loại bỏ các interval không thể lưu trữ
                delete stateToSave.tuXianInterval;
                delete stateToSave.combatInterval;
                delete stateToSave.npcCombatInterval;
                delete stateToSave.timeTickInterval;
                delete stateToSave.healthRegenInterval;
                delete stateToSave.currentMonster; 
                delete stateToSave.currentNPCCombat;

                localStorage.setItem('tu_tien_save_offline', JSON.stringify(stateToSave));
                window.logToConsole("•ĐÃ LƯU: Tiến trình Tu Luyện của bạn đã được lưu vào Local Storage.");
            } catch (e) {
                console.error("Lỗi khi lưu trữ Local Storage:", e);
                window.logToConsole("§LỖI: Không thể lưu trữ dữ liệu tu luyện vào trình duyệt.");
            }
        };

        // Đọc dữ liệu từ Local Storage
        window.loadGame = function() {
            try {
                const savedData = localStorage.getItem('tu_tien_save_offline');
                if (savedData) {
                    const loadedState = JSON.parse(savedData);
                    // Kiểm tra sơ bộ để tránh tải dữ liệu rỗng
                    if (Object.keys(loadedState).length > 5) {
                        return loadedState;
                    }
                }
                return null;
            } catch (e) {
                console.error("Lỗi khi tải dữ liệu Local Storage:", e);
                return null;
            }
        };

        // Dùng cho nút Lưu Trữ Tiến Trình
        window.handleActionSave = function() {
            window.saveGame(gameState);
        };
    </script>

    <style>
        /* Custom Pixel Art Styling and Layout Fixes */
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

        :root {
            --pixel-font: 'VT323', monospace;
            --primary-color: #3b82f6; /* Blue */
            --dark-bg: #1f2937; /* Gray 800 */
            --console-bg: #111827; /* Gray 900 */
            --border-color: #4b5563; /* Gray 600 */
        }

        body {
            font-family: var(--pixel-font);
            background-color: var(--dark-bg);
            color: #d1d5db;
        }

        .pixel-border {
            border: 4px solid var(--border-color);
            box-shadow: 6px 6px 0px rgba(0, 0, 0, 0.5);
            border-radius: 0;
        }
        .pixel-card {
            border: 2px solid var(--border-color);
            padding: 8px;
        }

        /* --- BUTTON STYLING (Improved Hover/Active) --- */
        .game-button {
            font-size: 1.25rem;
            text-shadow: 2px 2px 0px rgba(0, 0, 0, 0.7);
            border: 3px solid #6ee7b7; /* Emerald 300 */
            background-color: #047857; /* Emerald 700 */
            transition: all 0.1s;
            line-height: 1;
            padding: 8px 12px;
            cursor: pointer;
            box-shadow: 2px 2px 0px #10b981;
        }

        .game-button:hover:not(:disabled) {
            background-color: #065f46;
            box-shadow: 4px 4px 0px #10b981;
            transform: translate(-2px, -2px);
        }

        .game-button:active:not(:disabled) {
            background-color: #059669;
            box-shadow: 0px 0px 0px #059669;
            transform: translate(0, 0);
        }
        
        .game-button:disabled {
             cursor: not-allowed;
             opacity: 0.6;
        }

        .tab-button {
             background-color: #374151; /* Gray 700 */
             border-bottom: 3px solid var(--border-color);
        }
        .tab-button.active {
             background-color: #4b5563; /* Gray 600 */
             border-bottom: 3px solid #fcd34d; /* Amber */
             color: #fcd34d;
        }


        /* --- CONSOLE AND PROGRESS BARS --- */
        #game-console {
            height: 150px;
            overflow-y: auto;
            white-space: pre-wrap;
            line-height: 1.2;
            padding: 1rem;
            background-color: var(--console-bg);
        }
        
        .progress-bar-hp, .progress-bar-exp, .progress-bar-monster-hp, .progress-bar-mp {
            background-color: #4b5563;
            height: 12px;
            border: 1px solid var(--border-color);
        }

        .progress-fill-hp {
            height: 100%;
            background-color: #ef4444; /* Red */
            transition: width 0.3s ease-in-out;
        }
        .progress-fill-exp {
            height: 100%;
            background-color: #3b82f6; /* Blue */
            transition: width 0.3s ease-in-out;
        }
        .progress-fill-monster-hp {
            height: 100%;
            background-color: #fcd34d; /* Amber/Yellow for Monster */
            transition: width 0.3s ease-in-out;
        }
        .progress-fill-mp {
            height: 100%;
            background-color: #9333ea; /* Purple for MP/Mana */
            transition: width 0.3s ease-in-out;
        }
        
        /* --- NEW STATS PANEL STYLING --- */
        .stat-group-header {
            font-size: 1.5rem;
            color: #fcd34d;
            border-bottom: 2px solid #4b5563;
            padding-bottom: 4px;
            margin-bottom: 8px;
            text-align: center;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            font-size: 1.15rem;
        }
    </style>
</head>
<body class="p-4 flex justify-center items-center min-h-screen">

    <div id="game-container" class="w-full max-w-6xl pixel-border bg-gray-800 p-6">
        <h1 class="text-4xl text-center mb-4 text-yellow-300">HÀNH TRÌNH VÔ THƯỢNG</h1>
        <p id="user-id-display" class="text-sm text-center mb-2 text-gray-500">Chế độ: OFFLINE (Lưu trữ cục bộ)</p>
        <p id="time-display" class="text-xl text-center mb-4 text-orange-400">Ngày: 1 | Tháng: 1</p>


        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            
            <div id="stats-panel" class="lg:col-span-1 flex flex-col space-y-4">
                
                <div class="pixel-card bg-gray-700 p-0">
                    <div id="character-art" class="bg-gray-900 h-48 flex justify-center items-center text-gray-500 text-xl font-bold border-b-4 border-gray-600">
                        Ảnh Nhân Vật (Sẽ cập nhật sau)
                    </div>
                    
                    <div class="p-4">
                        <h2 class="stat-group-header text-yellow-300">THÔNG TIN CƠ BẢN</h2>
                        <div class="stat-item">
                            <span>Cảnh Giới:</span> <span id="stat-realm" class="text-green-400 font-bold"></span>
                        </div>
                        <div class="stat-item">
                            <span>Linh Thạch:</span> <span id="stat-money" class="text-yellow-400 font-bold"></span>
                        </div>
                    </div>
                </div>

                <div class="pixel-card bg-gray-700">
                    <h2 class="stat-group-header text-red-400">CHỈ SỐ CHIẾN ĐẤU</h2>
                    
                    <div class="stat-item">
                        <span>Tấn Công:</span> <span id="stat-attack" class="text-red-400 font-bold">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Phòng Thủ:</span> <span id="stat-defense" class="text-blue-400 font-bold">0</span>
                    </div>
                    
                    <p class="mt-4 mb-1">HP: <span id="stat-hp" class="text-red-400">0/0</span></p>
                    <div class="progress-bar-hp">
                        <div id="hp-progress" class="progress-fill-hp" style="width: 100%"></div>
                    </div>
                    
                    <p class="mt-2 mb-1">Linh Khí (MP): <span id="stat-mp" class="text-purple-400">0/0</span></p>
                    <div class="progress-bar-mp">
                        <div id="mp-progress" class="progress-fill-mp" style="width: 100%"></div>
                    </div>
                </div>
                
                <div class="pixel-card bg-gray-700">
                    <h2 class="stat-group-header text-blue-400">THÔNG TIN TU LUYỆN</h2>
                    
                    <div class="stat-item">
                        <span>Linh Căn:</span> <span id="stat-spirit-root" class="text-purple-400 font-bold"></span>
                    </div>
                    <div class="stat-item">
                        <span>Căn Cốt:</span> <span id="stat-bone" class="text-orange-400 font-bold"></span>
                    </div>
                    <div class="stat-item mt-2">
                        <span>Công Pháp:</span> <span id="stat-cultivation-method" class="text-blue-300 font-bold"></span>
                    </div>

                    <div id="sect-info" class="mt-4 text-sm text-center"></div>
                </div>

                <div class="pixel-card bg-gray-700">
                    <h2 class="stat-group-header text-green-400">TIẾN TRÌNH TU VI</h2>
                    <p class="text-base mb-1">Tu Vi: <span id="stat-exp" class="text-blue-400">0</span></p>
                    <div class="progress-bar-exp">
                        <div id="exp-progress" class="progress-fill-exp" style="width: 0%"></div>
                    </div>
                    <button class="game-button p-2 text-base w-full mt-3" onclick="handleActionSave()">LƯU TRỮ TIẾN TRÌNH</button>
                </div>


            </div>

            <div class="lg:col-span-3 flex flex-col">
                <div id="main-tabs" class="grid grid-cols-5 gap-0 mb-0 border-b-4 border-gray-600">
                    <button id="tab-TuoXian" class="tab-button p-3 text-xl active" onclick="switchView('TuoXian')">TỌA THIỀN</button>
                    <button id="tab-Combat" class="tab-button p-3 text-xl" onclick="switchView('Combat')">CHIẾN ĐẤU</button>
                    <button id="tab-Trade" class="tab-button p-3 text-xl" onclick="switchView('Trade')">THƯƠNG HỘI</button>
                    <button id="tab-Sect" class="tab-button p-3 text-xl" onclick="switchView('Sect')">TÔNG MÔN</button>
                    <button id="tab-NPC" class="tab-button p-3 text-xl" onclick="switchView('NPC')">NPC</button>
                </div>

                <div id="main-content" class="min-h-72 pixel-border bg-gray-700 p-4 flex-grow">
                    </div>

                <div id="game-console" class="mt-4 pixel-border">
                    </div>
            </div>

        </div>
    </div>

    <script>
        // --- GAME DATA AND CONFIGURATION (NO CHANGE) ---
        const GAME_TICK_INTERVAL = 1000; // 1 second
        const DAY_DURATION_TICKS = 60; // 60 seconds = 1 day
        const TOURNAMENT_INTERVAL_DAYS = 6; // Tỷ Võ Tông Môn 6 ngày/lần

        // CĂN CỐT (Total Rarity of last 3 is 10%)
        const BONE_QUALITIES = [
            { name: "Phế Vật Cốt", multiplier: 0.5, breakthroughBonus: -0.10, hpBonus: 0.5, rarity: 15 },
            { name: "Phàm Cốt", multiplier: 1.0, breakthroughBonus: 0.00, hpBonus: 1.0, rarity: 25 },
            { name: "Linh Cốt", multiplier: 1.5, breakthroughBonus: 0.05, hpBonus: 1.5, rarity: 25 },
            { name: "Tiên Cốt", multiplier: 2.0, breakthroughBonus: 0.10, hpBonus: 2.0, rarity: 20 },
            { name: "Thần Cốt", multiplier: 3.0, breakthroughBonus: 0.15, hpBonus: 3.0, rarity: 5 }, // 5%
            { name: "Thiên Cốt (Vô Song)", multiplier: 4.0, breakthroughBonus: 0.20, hpBonus: 4.0, rarity: 3 }, // 3%
            { name: "Thánh Cốt (Cấm Kỵ)", multiplier: 5.0, breakthroughBonus: 0.25, hpBonus: 5.0, rarity: 1.5 }, // 1.5%
            { name: "Hỗn Độn Cốt (Tuyệt Thế)", multiplier: 6.0, breakthroughBonus: 0.30, hpBonus: 6.0, rarity: 0.5 }, // 0.5%
        ];
        
        // LINH CĂN (Total Rarity of last 3 is 10%)
        const SPIRIT_ROOTS = [
            { name: "Phế Linh Căn", multiplier: 0.5, mpBonus: 0.5, mpRegen: 0.5, rarity: 15 },
            { name: "Ngũ Hành Căn", multiplier: 1.0, mpBonus: 1.0, mpRegen: 1.0, rarity: 25 },
            { name: "Biến Dị Căn (Phong/Lôi)", multiplier: 1.5, mpBonus: 1.5, mpRegen: 1.5, rarity: 25 },
            { name: "Đơn Linh Căn (Hoàn Mỹ)", multiplier: 2.5, mpBonus: 2.5, mpRegen: 2.0, rarity: 20 },
            { name: "Thiên Linh Căn", multiplier: 4.0, mpBonus: 4.0, mpRegen: 3.0, rarity: 5 }, // 5%
            { name: "Huyền Băng Căn (Hiếm)", multiplier: 5.0, mpBonus: 5.0, mpRegen: 4.0, rarity: 3 }, // 3%
            { name: "Thái Dương Căn (Cực Hiếm)", multiplier: 6.0, mpBonus: 6.0, mpRegen: 5.0, rarity: 1.5 }, // 1.5%
            { name: "Hỗn Độn Căn (Vô Thượng)", multiplier: 8.0, mpBonus: 8.0, mpRegen: 6.0, rarity: 0.5 }, // 0.5%
        ];

        // CÔNG PHÁP MỚI
        // Loại bỏ công pháp mặc định và thêm 'Tàng Kinh Các' công pháp
        const CULTIVATION_METHODS = [
            { name: "Thái Huyền Kiếm Quyết", bonus: { atk: 10, expMultiplier: 1.0 }, cost: 0, description: "Tăng 10 Tấn Công, Tốc độ Tu Vi x1.0." },
            { name: "Vạn Pháp Quy Nguyên Công", bonus: { def: 10, expMultiplier: 1.0 }, cost: 0, description: "Tăng 10 Phòng Thủ, Tốc độ Tu Vi x1.0." },
            { name: "Huyết Sát Ma Kinh", bonus: { atk: 25, hp: 0.1, expMultiplier: 0.8 }, cost: 50000, description: "Tăng 25 Tấn Công, 10% Max HP. Tốc độ Tu Vi x0.8. (50,000 LT)." },
            { name: "Thanh Mộc Trường Sinh Quyết", bonus: { hp: 0.2, def: 5, expMultiplier: 1.2 }, cost: 75000, description: "Tăng 20% Max HP, 5 Phòng Thủ. Tốc độ Tu Vi x1.2. (75,000 LT)." },
            { name: "Kim Cương Bất Hoại", bonus: { def: 30, expMultiplier: 0.9 }, cost: 100000, description: "Tăng 30 Phòng Thủ. Tốc độ Tu Vi x0.9. (100,000 LT)." },
            { name: "Vô Thượng Thiên Công", bonus: { atk: 50, def: 50, expMultiplier: 1.5 }, cost: 100, isSectSkill: true, sectContribution: 10000, description: "Chỉ số toàn diện. Cần Cống Hiến Tông Môn 10,000." },
        ];


        const REALMS = [
            { name: "Phàm Nhân", maxExp: 1000, color: "text-gray-400", baseDmg: 5, baseDef: 0 },
            { name: "Luyện Khí Tầng 1", maxExp: 2500, color: "text-yellow-400", baseDmg: 15, baseDef: 5 },
            { name: "Luyện Khí Tầng 2", maxExp: 5000, color: "text-yellow-400", baseDmg: 25, baseDef: 10 },
            { name: "Luyện Khí Tầng 3", maxExp: 8000, color: "text-yellow-400", baseDmg: 35, baseDef: 15 },
            { name: "Trúc Cơ Sơ Kỳ", maxExp: 15000, color: "text-green-400", baseDmg: 60, baseDef: 25 },
            { name: "Trúc Cơ Trung Kỳ", maxExp: 30000, color: "text-green-400", baseDmg: 90, baseDef: 40 },
            { name: "Kim Đan Sơ Kỳ", maxExp: 60000, color: "text-red-400", baseDmg: 150, baseDef: 70 },
            { name: "Kim Đan Trung Kỳ", maxExp: 100000, color: "text-red-400", baseDmg: 200, baseDef: 100 },
            { name: "Nguyên Anh Sơ Kỳ", maxExp: 200000, color: "text-purple-400", baseDmg: 350, baseDef: 180 },
            { name: "Nguyên Anh Trung Kỳ", maxExp: 400000, color: "text-purple-400", baseDmg: 500, baseDef: 250 },
            { name: "Hóa Thần Sơ Kỳ", maxExp: 800000, color: "text-indigo-400", baseDmg: 700, baseDef: 350 },
            { name: "Hóa Thần Trung Kỳ", maxExp: 1500000, color: "text-indigo-400", baseDmg: 1000, baseDef: 500 },
            { name: "Luyện Hư", maxExp: 3000000, color: "text-pink-400", baseDmg: 1500, baseDef: 750 },
            { name: "Hợp Thể", maxExp: 6000000, color: "text-pink-400", baseDmg: 2500, baseDef: 1000 },
            { name: "Đại Thừa", maxExp: 12000000, color: "text-cyan-400", baseDmg: 4000, baseDef: 1500 },
            { name: "Độ Kiếp (Cực Hạn)", maxExp: 999999999, color: "text-yellow-100", baseDmg: 6000, baseDef: 2500 },
        ];
        
        const SKILLS = [
            { name: "Đột Kích (Cơ bản)", damageMultiplier: 1.5, mpCost: 20, description: "Gây 150% sát thương, tốn 20 MP." }
        ];

        const MONSTERS = [
            { id: 0, name: "Linh Xà Độc", minRealm: 0, requiredRealm: "Phàm Nhân", baseHp: 50, baseAtk: 5, exp: 100, loot: { 'Yêu Thú Tàn Thi': 1.0, 'Bình Phàm Đan': 0.1 } },
            { id: 1, name: "Hắc Báo Y", minRealm: 2, requiredRealm: "Luyện Khí Tầng 2", baseHp: 150, baseAtk: 15, exp: 300, loot: { 'Yêu Thú Tàn Thi': 0.7, 'Hắc Báo Bì': 0.5, 'Linh Căn Thảo': 0.05 } },
            { id: 2, name: "Phi Thiên Hổ", minRealm: 4, requiredRealm: "Trúc Cơ Sơ Kỳ", baseHp: 500, baseAtk: 40, exp: 1000, loot: { 'Linh Thú Cốt': 0.7, 'Thiên Lang Đan': 0.2, 'Kim Tinh Thạch': 0.01 } },
            { id: 3, name: "Tứ Giai Ma Thú", minRealm: 7, requiredRealm: "Kim Đan Sơ Kỳ", baseHp: 1200, baseAtk: 80, exp: 2500, loot: { 'Ma Thú Huyết': 0.8, 'Huyền Thiết': 0.3, 'Bí Pháp Quyển': 0.005, 'Long Lân': 0.001 } }, // Đồ hiếm 0.1%
            { id: 4, name: "Thượng Cổ Ma Long", minRealm: 10, requiredRealm: "Nguyên Anh Sơ Kỳ", baseHp: 5000, baseAtk: 200, exp: 8000, loot: { 'Long Lân': 0.9, 'Nội Đan': 0.5, 'Thiên Thần Đan': 0.005 } }, // Đồ hiếm 0.5%
            { id: 5, name: "Cửu Vỹ Hồ Ly", minRealm: 13, requiredRealm: "Luyện Hư", baseHp: 15000, baseAtk: 500, exp: 30000, loot: { 'Hồ Yêu Nội Đan': 1.0, 'Huyền Thiết': 0.5, 'Tử Kim Linh Thạch': 0.05 } }, // Đồ hiếm 5%
        ];

        // PHÓ BẢN MỚI
        const DUNGEONS = [
            { id: 'ancient_tomb', name: "Cổ Mộ Tiên Tôn", requiredRealm: "Trúc Cơ Trung Kỳ", realmIndex: 5, reward: 20000, exp: 5000, baseHp: 3000, baseAtk: 150, loot: { 'Tử Kim Linh Thạch': 0.1, 'Bí Pháp Quyển': 0.5 } },
            { id: 'demon_realm', name: "Ma Giới Liệt Kê", requiredRealm: "Kim Đan Trung Kỳ", realmIndex: 8, reward: 50000, exp: 15000, baseHp: 10000, baseAtk: 400, loot: { 'Thiên Thần Đan': 0.1, 'Tử Kim Linh Thạch': 0.5 } },
        ];

        const LOOT_PRICES = {
            'Yêu Thú Tàn Thi': { price: 20, type: 'common' },
            'Bình Phàm Đan': { price: 50, type: 'common' },
            'Hắc Báo Bì': { price: 80, type: 'common' },
            'Linh Căn Thảo': { price: 300, type: 'common' },
            'Linh Thú Cốt': { price: 150, type: 'common' },
            'Thiên Lang Đan': { price: 500, type: 'common' },
            'Ma Thú Huyết': { price: 400, type: 'common' },
            'Huyền Thiết': { price: 1000, type: 'common' },
            'Kim Tinh Thạch': { price: 5000, type: 'rare' }, 
            'Bí Pháp Quyển': { price: 15000, type: 'rare' },
            'Long Lân': { price: 8000, type: 'rare' },
            'Nội Đan': { price: 20000, type: 'rare' },
            'Hồ Yêu Nội Đan': { price: 50000, type: 'rare' },
            'Thiên Thần Đan': { price: 100000, type: 'super_rare' },
            'Tử Kim Linh Thạch': { price: 500000, type: 'super_rare' },
            // VẬT PHẨM MỚI: Tỷ lệ rơi 1% (0.01)
            'Thiên Phạt Lệnh': { price: 100000, type: 'super_rare' }, 
        };

        const TRADE_ITEMS = [
            { name: "Linh Khí Phù", price: 100, bonus: 500, type: "exp", description: "Tăng 500 Tu Vi." },
            { name: "Giáp Da Thú", price: 200, bonus: 10, type: "def", description: "Tăng 10 điểm Phòng Thủ vĩnh viễn." },
            { name: "Trúc Cơ Đan", price: 5000, bonus: 1, type: "breakthrough", description: "Đảm bảo đột phá thành công cảnh giới hiện tại." },
        ];
        
        // Items for Daily Shop Special & Monthly Auction
        const SPECIAL_ITEMS = [
            { name: "Hồi Lực Đan", price: 500, type: "mp", bonus: 50, description: "Hồi 50 Linh Khí (MP)." },
            { name: "Trúc Nhan Đan", price: 1000, type: "hp", bonus: 0.5, description: "Tăng 0.5% HP Tối Đa vĩnh viễn (Tính theo cấp độ)." },
            { name: "Tấn Công Phù", price: 2000, type: "atk", bonus: 20, description: "Tăng 20 điểm Tấn Công vĩnh viễn." },
        ];

        const AUCTION_ITEMS = [
            { name: "Cải Cốt Đan", basePrice: 50000, type: "bone_change", description: "Cơ hội cải tạo Căn Cốt cao hơn (Cực Hiếm)." },
            { name: "Tẩy Tủy Đan", basePrice: 80000, type: "root_change", description: "Cơ hội cải tạo Linh Căn cao hơn (Cực Hiếm)." },
            { name: "Thần Binh Phù", basePrice: 150000, type: "atk_mega", bonus: 100, description: "Tăng 100 điểm Tấn Công vĩnh viễn (Siêu phẩm)." },
        ];
        
        const MOCK_NPCS = [
            { id: 'thanhvan', name: "Sư Tỷ Thanh Vân", realm: "Luyện Khí Tầng 3", baseAtk: 50, baseDef: 20, baseHp: 300, isChallengable: false, description: "Bận rộn luyện đan, có thể chỉ điểm công pháp." },
            { id: 'truonglao', name: "Trưởng Lão Dược Các", realm: "Trúc Cơ Trung Kỳ", baseAtk: 100, baseDef: 50, baseHp: 800, isChallengable: false, description: "Người quản lý vật phẩm hiếm, có thể trao đổi bảo vật." },
            { 
                id: 'thientai', 
                name: "Thiên Tài Huyền Băng", 
                realm: "Kim Đan Sơ Kỳ", 
                baseAtk: 200, 
                baseDef: 100, 
                baseHp: 1500, 
                isChallengable: true, 
                reward: 10000, 
                description: "Tu Giả kiêu ngạo, có thể thách đấu để nhận thưởng lớn.",
                loot: { 'Thiên Phạt Lệnh': 0.001 } // Tỷ lệ rơi 0.1%
            },
            { 
                id: 'sugia', 
                name: "Sư Già Tiền Bối", 
                realm: "Nguyên Anh Hậu Kỳ", 
                baseAtk: 500, 
                baseDef: 250, 
                baseHp: 5000, 
                isChallengable: true, 
                reward: 50000, 
                description: "Cao nhân ẩn dật, có thể thách đấu để nhận thưởng khủng.",
                loot: { 'Thiên Phạt Lệnh': 0.01 } // Tỷ lệ rơi 1% theo yêu cầu
            }
        ];
        
        const SECTS = [
            { name: "Thái Huyền Kiếm Tông", expBonus: 1.1, defBonus: 10, requirement: 3 }, // Luyện Khí 3
            { name: "Vạn Pháp Các", expBonus: 1.2, defBonus: 5, requirement: 5 }, // Trúc Cơ Sơ Kỳ
            { name: "Huyết Ma Giáo", expBonus: 1.0, defBonus: 20, requirement: 7 }, // Kim Đan Sơ Kỳ
        ];


        // --- GAME STATE (Initial Values for New Game) ---
        const initialGameState = {
            realmIndex: 0,
            experience: 0,
            spiritStone: 100, 
            currentHP: 100,
            maxHP: 100,
            currentMP: 50, // Initial MP
            maxMP: 50,     // Initial Max MP
            mpRegenRate: 1, // Initial Regen
            baseAttack: 10,
            baseDefense: 5,
            spiritRoot: null, 
            boneQuality: null, 
            spiritRootName: null, 
            boneQualityName: null, 
            cultivationMethodName: null, // KHÔNG CÓ CÔNG PHÁP BAN ĐẦU
            cultivationMethod: null,     // KHÔNG CÓ CÔNG PHÁP BAN ĐẦU
            inventory: { 
                'Yêu Thú Tàn Thi': 0, 
                'Bình Phàm Đan': 0, 
                'Hắc Báo Bì': 0, 
                'Kim Tinh Thạch': 0, 
                'Bí Pháp Quyển': 0, 
                'Trúc Cơ Đan': 0, 
                'Linh Căn Thảo': 0, 
                'Thiên Phạt Lệnh': 0 
            },
            currentView: 'TuoXian',
            currentMonster: null,
            currentNPCCombat: null,
            // Time & Shop States
            currentDay: 1,
            lastAuctionDay: 0,
            dailyItem: null,
            auctionItem: null, // Vật phẩm đấu giá hiện tại
            auctionPrice: 0,   // Giá hiện tại
            auctionBidder: 'NPC 1', // Người đặt giá cao nhất
            
            // NPC interaction states
            npcInteractions: {
                thanhvan_advice_atk: false,
                sugia_advice_def: false,
            },
            // SECT SYSTEM STATES
            sectName: null, // Tên tông môn đang tham gia
            sectRank: 'Phổ Thông Đệ Tử',
            sectContribution: 0, // Cống hiến tông môn
            sectBenefits: { expBonus: 1.0, defBonus: 0 },
            lastTournamentDay: 0, // Ngày cuối cùng diễn ra tỷ võ
            currentCombatMode: 'Wilderness', // 'Wilderness' or 'Dungeon'
            learnedMethods: [], // Mảng chứa tên công pháp đã học
        };

        let gameState = {}; // State will be loaded/initialized here
        let tuXianInterval = null;
        let combatInterval = null;
        let npcCombatInterval = null;
        let healthRegenInterval = null;
        let timeTickInterval = null;
        let selectedNPC = null;
        let gameTicks = 0; // for day tracking

        // --- CORE GAME FUNCTIONS ---
        
        window.logToConsole = function(message) {
            const consoleElement = document.getElementById('game-console');
            let logMessage = `<p class="text-sm my-1">${message}</p>`;
            if (message.startsWith("§")) {
                logMessage = `<p class="text-base my-1 font-bold text-yellow-300">${message.substring(1)}</p>`;
            } else if (message.startsWith("•")) {
                logMessage = `<p class="text-sm my-1 text-green-400">${message}</p>`;
            } else if (message.startsWith("X")) {
                logMessage = `<p class="text-sm my-1 text-red-500">${message.substring(1)}</p>`;
            } else if (message.startsWith("!")) {
                logMessage = `<p class="text-sm my-1 text-purple-400">${message.substring(1)}</p>`;
            }
            consoleElement.innerHTML += logMessage;
            consoleElement.scrollTop = consoleElement.scrollHeight;
        }

        // --- INITIALIZATION & GAME START ---
        
        function pickRandomStat(statList) {
            const totalRarity = statList.reduce((sum, s) => sum + s.rarity, 0);
            let rand = Math.random() * totalRarity;
            for (const stat of statList) {
                if (rand < stat.rarity) {
                    return stat;
                }
                rand -= stat.rarity;
            }
            return statList[0]; // Fallback
        }

        function generateInitialStats(state) {
            const root = pickRandomStat(SPIRIT_ROOTS);
            const bone = pickRandomStat(BONE_QUALITIES);
            state.spiritRoot = root.multiplier;
            state.spiritRootName = root.name;
            state.boneQuality = bone.multiplier;
            state.boneQualityName = bone.name;
            
            // Bỏ qua việc chọn Công pháp khởi đầu, để null
            state.cultivationMethodName = null;
            state.cultivationMethod = null;

            return state;
        }

        // Main function to start the game
        window.onload = function() {
            window.startGame();
        };

        window.startGame = function() {
            const loadedState = window.loadGame();
            if (loadedState) {
                // Merge loaded state with initial to ensure new properties are added (like sectName)
                gameState = { ...initialGameState, ...loadedState };

                // Ensure new properties exist after loading old save
                gameState.npcInteractions = gameState.npcInteractions || initialGameState.npcInteractions;
                gameState.currentDay = gameState.currentDay || 1;
                gameState.lastAuctionDay = gameState.lastAuctionDay || 0;
                gameState.sectBenefits = gameState.sectBenefits || initialGameState.sectBenefits;
                gameState.sectRank = gameState.sectRank || initialGameState.sectRank;
                gameState.sectContribution = gameState.sectContribution || initialGameState.sectContribution;
                gameState.lastTournamentDay = gameState.lastTournamentDay || initialGameState.lastTournamentDay;
                gameState.currentCombatMode = gameState.currentCombatMode || initialGameState.currentCombatMode;
                gameState.learnedMethods = gameState.learnedMethods || initialGameState.learnedMethods;

                // Ensure the loaded cultivation method object is correct
                if (gameState.cultivationMethodName) {
                    gameState.cultivationMethod = CULTIVATION_METHODS.find(m => m.name === gameState.cultivationMethodName) || null;
                } else {
                    gameState.cultivationMethod = null;
                }

                // Check for missing inventory items (new items added)
                for (const item in LOOT_PRICES) {
                    if (gameState.inventory[item] === undefined) {
                         gameState.inventory[item] = 0;
                    }
                }
                
                logToConsole(`§TẢI THÀNH CÔNG: Tiếp tục hành trình từ Cảnh Giới ${REALMS[gameState.realmIndex].name}.`);
            } else {
                gameState = generateInitialStats({ ...initialGameState });
                logToConsole("§KHỞI TẠO MỚI: Không tìm thấy dữ liệu lưu. Bắt đầu hành trình mới.");
                logToConsole(`§TẠO NHÂN VẬT: Linh Căn của bạn là **${gameState.spiritRootName}** (x${gameState.spiritRoot})!`);
                logToConsole(`§TẠO NHÂN VẬT: Căn Cốt của bạn là **${gameState.boneQualityName}** (x${gameState.boneQuality})!`);
                logToConsole(`XNHẮC NHỞ: Bạn không có Công Pháp. Hãy đến Tông Môn để học Công Pháp cơ bản!`);
                window.saveGame(gameState);
            }

            // Generate daily item if missing 
            if (!gameState.dailyItem || (gameState.currentDay !== 1 && !SPECIAL_ITEMS.find(i => i.name === gameState.dailyItem.name))) {
                generateDailySpecialItem();
            }

            finalizeInit();
        }

        function finalizeInit() {
            if (tuXianInterval) clearInterval(tuXianInterval);
            if (combatInterval) clearInterval(combatInterval);
            if (npcCombatInterval) clearInterval(npcCombatInterval);
            if (healthRegenInterval) clearInterval(healthRegenInterval);
            if (timeTickInterval) clearInterval(timeTickInterval);

            calculateStats();
            updateUI();
            startTuoXianLoop();
            startRegenLoop();
            startTimeTick();
            switchView(gameState.currentView || 'TuoXian');
        }

        function calculateStats() {
            const currentRealm = REALMS[gameState.realmIndex];
            const boneStat = BONE_QUALITIES.find(b => b.name === gameState.boneQualityName);
            const rootStat = SPIRIT_ROOTS.find(r => r.name === gameState.spiritRootName);

            // 1. TÍNH CHỈ SỐ CƠ BẢN
            let totalMaxHP = 100 + (currentRealm.baseDmg * 5); // Base HP
            totalMaxHP += (boneStat.hpBonus * currentRealm.baseDmg * 5); // Bone HP Multiplier
            let totalMaxMP = 50 + (currentRealm.baseDef * 2); // Base MP
            totalMaxMP += (rootStat.mpBonus * currentRealm.baseDef * 2); // Root MP Multiplier

            let totalAttack = currentRealm.baseDmg + gameState.baseAttack;
            let totalDefense = currentRealm.baseDef + gameState.baseDefense;
            let expMultiplier = 1.0;
            let mpRegenRate = rootStat.mpRegen;

            // 2. TÍNH TOÁN CÔNG PHÁP (MỚI)
            if (gameState.cultivationMethod) {
                const methodBonus = gameState.cultivationMethod.bonus;
                totalAttack += (methodBonus.atk || 0);
                totalDefense += (methodBonus.def || 0);
                expMultiplier *= (methodBonus.expMultiplier || 1.0);
                totalMaxHP *= (1 + (methodBonus.hp || 0)); // % HP Bonus
            }

            // 3. TÍNH TOÁN LỢI ÍCH TÔNG MÔN
            if (gameState.sectBenefits) {
                totalDefense += gameState.sectBenefits.defBonus;
                expMultiplier *= gameState.sectBenefits.expBonus;
            }

            // 4. CẬP NHẬT TRẠNG THÁI
            gameState.totalAttack = Math.floor(totalAttack);
            gameState.totalDefense = Math.floor(totalDefense);
            gameState.expMultiplier = expMultiplier;
            gameState.mpRegenRate = mpRegenRate;
            gameState.maxHP = Math.floor(totalMaxHP);
            gameState.maxMP = Math.floor(totalMaxMP);
            
            // Giữ HP/MP hiện tại không vượt quá Max
            gameState.currentHP = Math.min(gameState.currentHP, gameState.maxHP);
            gameState.currentMP = Math.min(gameState.currentMP, gameState.maxMP);
        }

        function checkLevelUp() {
            const currentRealm = REALMS[gameState.realmIndex];
            if (gameState.experience >= currentRealm.maxExp) {
                // Thử đột phá
                const boneStat = BONE_QUALITIES.find(b => b.name === gameState.boneQualityName);
                const breakthroughChance = 0.5 + boneStat.breakthroughBonus; // Base 50% + Bone Bonus
                const hasBreakthroughPill = gameState.inventory['Trúc Cơ Đan'] > 0;
                
                let success = false;
                if (hasBreakthroughPill || Math.random() < breakthroughChance) {
                    success = true;
                }

                if (success) {
                    gameState.realmIndex++;
                    gameState.experience = 0;
                    gameState.currentHP = gameState.maxHP;
                    gameState.currentMP = gameState.maxMP;
                    logToConsole(`§ĐỘT PHÁ THÀNH CÔNG! Bạn đã tiến lên **${REALMS[gameState.realmIndex].name}**!`);
                    if (hasBreakthroughPill) {
                         gameState.inventory['Trúc Cơ Đan']--;
                         logToConsole(`•Trúc Cơ Đan đã được sử dụng. Tồn kho còn: ${gameState.inventory['Trúc Cơ Đan']}.`);
                    }
                    // Cập nhật chỉ số sau khi lên cấp
                    calculateStats(); 
                } else {
                    gameState.experience = currentRealm.maxExp * 0.9; // Giảm 10% kinh nghiệm
                    logToConsole(`XĐỘT PHÁ THẤT BẠI. Tiêu hao linh khí, tu vi giảm nhẹ. Hãy thử lại!`);
                }
            }
        }

        // --- GAME LOOPS ---

        function startTuoXianLoop() {
            tuXianInterval = setInterval(() => {
                if (gameState.currentView !== 'TuoXian') return;
                
                // Tọa Thiền: Tăng EXP
                const expGain = 10 * gameState.expMultiplier;
                gameState.experience += expGain;
                
                checkLevelUp();
                updateUI();
                
            }, GAME_TICK_INTERVAL);
        }

        function startRegenLoop() {
            healthRegenInterval = setInterval(() => {
                // Tăng HP (tái tạo)
                const hpRegen = Math.max(1, Math.floor(gameState.maxHP * 0.01)); // 1% Max HP
                gameState.currentHP = Math.min(gameState.maxHP, gameState.currentHP + hpRegen);

                // Tăng MP (Hồi phục linh khí)
                gameState.currentMP = Math.min(gameState.maxMP, gameState.currentMP + gameState.mpRegenRate);

                if (gameState.currentView !== 'Combat' && gameState.currentView !== 'NPC') {
                    updateUI(); // Chỉ update khi không trong combat để tránh giật lag
                }
            }, GAME_TICK_INTERVAL);
        }

        function startTimeTick() {
            timeTickInterval = setInterval(() => {
                gameTicks++;

                if (gameTicks % DAY_DURATION_TICKS === 0) {
                    gameState.currentDay++;
                    logToConsole(`§Ngày thứ ${gameState.currentDay} đã bắt đầu.`);
                    
                    // Reset Daily Special Item
                    generateDailySpecialItem();
                    
                    // Xử lý đấu giá hàng tháng (Ngày 1 đầu tháng)
                    if (gameState.currentDay % 30 === 1) { // Coi như 30 ngày là 1 tháng
                        initializeAuction();
                    }

                    // Tỷ Võ Tông Môn (6 ngày/lần)
                    if (gameState.sectName && (gameState.currentDay - gameState.lastTournamentDay) >= TOURNAMENT_INTERVAL_DAYS) {
                         logToConsole(`!TÔNG MÔN: Tỷ Võ Tông Môn sẽ diễn ra vào hôm nay!`);
                         gameState.lastTournamentDay = gameState.currentDay;
                    }

                    updateUI(); // Cập nhật hiển thị ngày
                    
                    if (gameState.currentView === 'Trade') renderView('Trade'); // Re-render Trade tab to show new daily item/auction
                }
                
                document.getElementById('time-display').textContent = `Ngày: ${gameState.currentDay} | Tick: ${gameTicks % DAY_DURATION_TICKS}`;
                
            }, GAME_TICK_INTERVAL);
        }


        // --- COMBAT & MONSTER LOGIC ---

        function getMonsterStats(monster) {
            const realm = REALMS[monster.minRealm];
            const realmMultiplier = monster.minRealm + 1;
            return {
                hp: monster.baseHp + (realm.baseDmg * 10),
                atk: monster.baseAtk + (realm.baseDef * 5),
            };
        }

        function getDungeonStats(dungeon) {
             const realm = REALMS[dungeon.realmIndex];
             return {
                 hp: dungeon.baseHp + (realm.baseDmg * 15),
                 atk: dungeon.baseAtk + (realm.baseDef * 8),
             }
        }

        window.handleStartCombat = function(monsterId, mode = 'Wilderness', dungeonId = null) {
            window.stopCombat();
            
            const monsterData = MONSTERS.find(m => m.id === monsterId);
            const dungeonData = DUNGEONS.find(d => d.id === dungeonId);

            if (mode === 'Wilderness' && monsterData) {
                gameState.currentCombatMode = 'Wilderness';
                const stats = getMonsterStats(monsterData);
                gameState.currentMonster = {
                    ...monsterData,
                    currentHp: stats.hp,
                    maxHp: stats.hp,
                    attack: stats.atk,
                };
                logToConsole(`§Bắt đầu chiến đấu với **${monsterData.name}**!`);
                combatInterval = setInterval(gameCombatTick, GAME_TICK_INTERVAL);
                switchView('Combat');
            } else if (mode === 'Dungeon' && dungeonData) {
                if (gameState.realmIndex < dungeonData.realmIndex) {
                    logToConsole(`XKhông thể vào **${dungeonData.name}**. Yêu cầu cảnh giới tối thiểu: **${dungeonData.requiredRealm}**.`);
                    return;
                }
                gameState.currentCombatMode = 'Dungeon';
                const stats = getDungeonStats(dungeonData);
                gameState.currentMonster = {
                    ...dungeonData,
                    currentHp: stats.hp,
                    maxHp: stats.hp,
                    attack: stats.atk,
                };
                logToConsole(`!Bạn tiến vào Phó Bản **${dungeonData.name}**! Cẩn thận, quái vật rất mạnh!`);
                combatInterval = setInterval(gameCombatTick, GAME_TICK_INTERVAL);
                switchView('Combat');
            } else {
                logToConsole("XLỗi: Không tìm thấy quái vật hoặc chế độ chiến đấu không hợp lệ.");
            }
            updateUI();
        };

        window.stopCombat = function() {
            if (combatInterval) clearInterval(combatInterval);
            combatInterval = null;
            gameState.currentMonster = null;
        }

        function gameCombatTick() {
            if (!gameState.currentMonster) return;

            // Monster attack
            const monster = gameState.currentMonster;
            let monsterDamage = Math.max(1, monster.attack - gameState.totalDefense);
            gameState.currentHP = Math.max(0, gameState.currentHP - monsterDamage);

            // Player attack (Auto attack)
            const playerDamage = Math.max(1, gameState.totalAttack - monster.attack * 0.2); // Player damage ignores most monster defense
            monster.currentHp = Math.max(0, monster.currentHp - playerDamage);

            logToConsole(`XQuái vật gây **${monsterDamage}** sát thương. Bạn gây **${playerDamage}** sát thương.`);

            if (gameState.currentHP <= 0) {
                window.handleCombatLoss(monster);
            } else if (monster.currentHp <= 0) {
                window.handleCombatWin(monster);
            }

            updateUI();
        }
        
        window.handleActionSkill = function(skill) {
             if (gameState.currentView !== 'Combat' || !gameState.currentMonster) {
                 return logToConsole("XBạn không đang chiến đấu.");
             }
             if (gameState.currentMP < skill.mpCost) {
                 return logToConsole(`XKhông đủ Linh Khí (MP) để thi triển **${skill.name}** (Cần ${skill.mpCost}).`);
             }
             
             gameState.currentMP -= skill.mpCost;
             
             // Gây sát thương kỹ năng (VD: 1.5x Tấn Công)
             const skillDamage = Math.max(1, (gameState.totalAttack * skill.damageMultiplier) - gameState.currentMonster.attack * 0.2);
             gameState.currentMonster.currentHp = Math.max(0, gameState.currentMonster.currentHp - skillDamage);
             
             logToConsole(`!Bạn thi triển **${skill.name}**, gây **${skillDamage.toFixed(0)}** sát thương cực mạnh!`);
             
             if (gameState.currentMonster.currentHp <= 0) {
                 window.handleCombatWin(gameState.currentMonster);
             }
             updateUI();
        }

        window.handleCombatWin = function(monster) {
            window.stopCombat();
            
            // Dungeon clear rewards
            if (gameState.currentCombatMode === 'Dungeon') {
                 logToConsole(`§PHÓ BẢN: Bạn đã đánh bại Boss **${monster.name}**!`);
                 gameState.experience += monster.exp;
                 gameState.spiritStone += monster.reward;
                 logToConsole(`•Nhận: **${monster.exp} Tu Vi** và **${monster.reward.toLocaleString()} Linh Thạch**!`);
                 
                 // Dungeon Loot
                 for (const [lootName, dropChance] of Object.entries(monster.loot)) {
                     if (Math.random() < dropChance) {
                         const amount = Math.floor(Math.random() * 3) + 1;
                         gameState.inventory[lootName] = (gameState.inventory[lootName] || 0) + amount;
                         logToConsole(`•Chiến lợi phẩm: **${lootName} x${amount}**!`);
                     }
                 }
                 gameState.currentCombatMode = 'Wilderness'; // Reset mode after dungeon clear
            } else {
                 // Wilderness monster loot
                 logToConsole(`§CHIẾN THẮNG: Bạn đã đánh bại **${monster.name}**!`);
                 gameState.experience += monster.exp;
                 gameState.spiritStone += Math.floor(Math.random() * 20) + 10; // Base money loot
                 logToConsole(`•Nhận: **${monster.exp} Tu Vi**.`);
            
                 for (const [lootName, dropChance] of Object.entries(monster.loot)) {
                     if (Math.random() < dropChance) {
                         const amount = 1;
                         gameState.inventory[lootName] = (gameState.inventory[lootName] || 0) + amount;
                         logToConsole(`•Chiến lợi phẩm: **${lootName} x${amount}**!`);
                     }
                 }
            }

            checkLevelUp();
            updateUI();
            renderView('Combat'); // Re-render the combat view to show buttons again
            window.saveGame(gameState);
        }

        window.handleCombatLoss = function(monster) {
            window.stopCombat();
            
            if (gameState.currentCombatMode === 'Dungeon') {
                logToConsole(`XTHẤT BẠI: Bạn đã bị đánh bại trong Phó Bản **${monster.name}**. Mất 20% Linh Thạch!`);
                gameState.spiritStone = Math.floor(gameState.spiritStone * 0.8);
            } else {
                logToConsole(`XTHẤT BẠI: Bạn đã bị đánh bại bởi **${monster.name}**. Mất 10% Linh Thạch!`);
                gameState.spiritStone = Math.floor(gameState.spiritStone * 0.9);
            }
            
            gameState.currentHP = 1; // Hồi sinh với 1 HP
            gameState.currentMP = 1; // Hồi sinh với 1 MP
            
            updateUI();
            renderView('Combat'); // Re-render the combat view
            window.saveGame(gameState);
        }
        
        window.handleActionToggleAutoCombat = function() {
            if (gameState.currentCombatMode === 'Dungeon') {
                 return logToConsole("XKhông thể Tự Động Chiến Đấu trong Phó Bản. Chỉ được phép trong khu vực Hoang Dã.");
            }
            
            const button = document.getElementById('start-auto-combat-button');
            const monster = MONSTERS[0]; // Mặc định đánh quái đầu tiên
            
            if (button.textContent === 'BẬT TỰ ĐỘNG CHIẾN ĐẤU') {
                button.textContent = 'DỪNG TỰ ĐỘNG';
                window.logToConsole("•Bật chế độ Tự Động Chiến Đấu.");
                window.handleStartCombat(monster.id, 'Wilderness');
            } else {
                button.textContent = 'BẬT TỰ ĐỘNG CHIẾN ĐẤU';
                window.logToConsole("•Dừng chế độ Tự Động Chiến Đấu.");
                window.stopCombat();
                gameState.currentMonster = null;
                renderView('Combat');
            }
        }
        
        // --- NPC COMBAT LOGIC ---
        
        window.handleStartNPCCombat = function(npcId) {
            window.stopCombat();
            
            const npcData = MOCK_NPCS.find(n => n.id === npcId);
            if (!npcData || !npcData.isChallengable) {
                return logToConsole("XNPC này không thể thách đấu.");
            }
            
            const npcRealmIndex = REALMS.findIndex(r => r.name === npcData.realm);
            
            if (gameState.realmIndex < npcRealmIndex) {
                 return logToConsole(`XBạn không đủ cảnh giới để thách đấu ${npcData.name} (**${npcData.realm}**).`);
            }
            
            // Stop Tuo Xian loop if running
            if (tuXianInterval) clearInterval(tuXianInterval);
            tuXianInterval = null;
            
            // Set up NPC combat state
            gameState.currentNPCCombat = {
                ...npcData,
                currentHp: npcData.baseHp,
                maxHp: npcData.baseHp,
                attack: npcData.baseAtk,
                defense: npcData.baseDef
            };
            selectedNPC = npcData; // Lưu NPC đang chiến đấu
            
            logToConsole(`§Bắt đầu thách đấu **${npcData.name}**!`);
            npcCombatInterval = setInterval(gameNPCCombatTick, GAME_TICK_INTERVAL);
            switchView('NPC'); // Switch to NPC view to see combat
            updateUI();
        }
        
        window.stopNPCCombat = function() {
            if (npcCombatInterval) clearInterval(npcCombatInterval);
            npcCombatInterval = null;
            gameState.currentNPCCombat = null;
            selectedNPC = null;
            startTuoXianLoop(); // Resume Tọa Thiền
        }
        
        function gameNPCCombatTick() {
            if (!gameState.currentNPCCombat) return;
            
            const npc = gameState.currentNPCCombat;
            
            // NPC attack
            let npcDamage = Math.max(1, npc.attack - gameState.totalDefense);
            gameState.currentHP = Math.max(0, gameState.currentHP - npcDamage);
            
            // Player attack
            let playerDamage = Math.max(1, gameState.totalAttack - npc.defense);
            npc.currentHp = Math.max(0, npc.currentHp - playerDamage);
            
            logToConsole(`X**${npc.name}** gây **${npcDamage}** sát thương. Bạn gây **${playerDamage}** sát thương.`);

            if (gameState.currentHP <= 0) {
                window.handleNPCCombatLoss(npc);
            } else if (npc.currentHp <= 0) {
                window.handleNPCCombatWin(npc);
            }

            updateUI();
        }
        
        window.handleNPCCombatWin = function(npc) {
            window.stopNPCCombat();
            
            logToConsole(`§KHÍ PHÁCH: Bạn đã đánh bại **${npc.name}**!`);
            
            gameState.spiritStone += npc.reward;
            logToConsole(`•Nhận thưởng: **${npc.reward.toLocaleString()} Linh Thạch**!`);
            
            // NPC Loot
            if (npc.loot) {
                 for (const [lootName, dropChance] of Object.entries(npc.loot)) {
                     if (Math.random() < dropChance) {
                         const amount = 1;
                         gameState.inventory[lootName] = (gameState.inventory[lootName] || 0) + amount;
                         logToConsole(`•Chiến lợi phẩm HIẾM: **${lootName} x${amount}**!`);
                     }
                 }
            }
            
            updateUI();
            renderView('NPC');
            window.saveGame(gameState);
        }

        window.handleNPCCombatLoss = function(npc) {
            window.stopNPCCombat();
            
            logToConsole(`XTHẤT BẠI: Bạn đã bị **${npc.name}** đánh bại. Mất 10% Linh Thạch!`);
            gameState.spiritStone = Math.floor(gameState.spiritStone * 0.9);
            
            gameState.currentHP = 1; // Hồi sinh với 1 HP
            gameState.currentMP = 1; // Hồi sinh với 1 MP
            
            updateUI();
            renderView('NPC');
            window.saveGame(gameState);
        }


        // --- TRADE & SHOP LOGIC ---
        
        function generateDailySpecialItem() {
            // Pick a random item from SPECIAL_ITEMS
            const randomIndex = Math.floor(Math.random() * SPECIAL_ITEMS.length);
            gameState.dailyItem = SPECIAL_ITEMS[randomIndex];
            logToConsole(`•THƯƠNG HỘI: Vật phẩm đặc biệt hôm nay: **${gameState.dailyItem.name}**!`);
        }

        function initializeAuction() {
             logToConsole("!ĐẤU GIÁ HỘI: Đấu Giá Hội hàng tháng đã bắt đầu!");
             
             // 1. Chọn 1 vật phẩm đấu giá ngẫu nhiên
             const randomIndex = Math.floor(Math.random() * AUCTION_ITEMS.length);
             const item = AUCTION_ITEMS[randomIndex];
             
             // 2. Thiết lập giá cơ bản (BasePrice) và người đặt giá ban đầu
             gameState.auctionItem = item;
             gameState.auctionPrice = item.basePrice;
             gameState.auctionBidder = 'Hội Đồng Định Giá'; // Người giữ giá ban đầu
             gameState.lastAuctionDay = gameState.currentDay;
             
             logToConsole(`!ĐẤU GIÁ: Bảo vật hôm nay là **${item.name}**! Giá khởi điểm: **${item.basePrice.toLocaleString()} LT**.`);
        }
        
        window.handleBid = function(item, currentPrice) {
            if (!item) {
                 return logToConsole("XĐấu Giá Hội chưa mở hoặc vật phẩm không hợp lệ.");
            }
            
            // Tăng giá đấu: Giá hiện tại + 10%
            const bidIncrement = Math.max(1000, Math.floor(currentPrice * 0.1));
            const newBid = currentPrice + bidIncrement;
            
            if (gameState.spiritStone < newBid) {
                 return logToConsole(`XBạn không đủ Linh Thạch để đấu giá **${newBid.toLocaleString()} LT**.`);
            }
            
            // Xử lý logic đặt giá của NPC: Tỷ lệ NPC đấu giá lại
            // Tỷ lệ thành công dựa trên tổng Linh Thạch của người chơi
            const playerWealthBonus = gameState.spiritStone / 500000; // Càng giàu càng dễ thắng
            const npcBidChance = Math.max(0.05, 0.4 - playerWealthBonus); // Cơ hội NPC đấu lại từ 40% giảm dần

            // Giả định NPC đặt giá
            let npcWins = false;
            let finalPrice = newBid;
            let finalBidder = 'Bạn';
            
            // 2 vòng đặt giá ảo của NPC
            if (Math.random() < npcBidChance) {
                 finalPrice += bidIncrement;
                 finalBidder = 'NPC Đấu Giá Giấu Tên';
                 npcWins = true;
            }
            
            if (Math.random() < npcBidChance / 2 && npcWins) {
                 finalPrice += bidIncrement;
                 finalBidder = 'NPC Đấu Giá Giấu Tên';
            }
            
            // Cập nhật giá và người đấu giá cao nhất (Vòng 1: người chơi đặt giá)
            gameState.auctionPrice = newBid;
            gameState.auctionBidder = 'Bạn';
            
            // Cập nhật giá nếu NPC đấu lại
            if (npcWins) {
                 gameState.auctionPrice = finalPrice;
                 gameState.auctionBidder = finalBidder;
                 logToConsole(`!ĐẤU GIÁ: **${finalBidder}** đã vượt giá của bạn lên **${finalPrice.toLocaleString()} LT**!`);
                 // Nếu NPC thắng, người chơi không mất tiền
                 
            } else {
                 // Người chơi thắng
                 gameState.spiritStone -= newBid;
                 logToConsole(`•ĐẤU GIÁ: Bạn đặt giá thành công **${newBid.toLocaleString()} LT** và là người đặt giá cao nhất!`);
                 // Kích hoạt nút MUA
            }
            
            renderView('Trade');
        }
        
        window.handleBuyAuctionItem = function(item, price) {
            if (gameState.auctionBidder !== 'Bạn') {
                 return logToConsole("XBạn không phải là người đặt giá cao nhất. Không thể mua.");
            }
            
            // Người chơi đã bị trừ tiền trong hàm handleBid, nên chỉ cần lấy item và reset
            
            logToConsole(`§MUA THÀNH CÔNG: Bạn đã mua **${item.name}** với giá **${price.toLocaleString()} LT**!`);
            
            // Xử lý vật phẩm (Tương tự buyItem)
            switch (item.type) {
                 case 'bone_change':
                     handleStatChange('bone');
                     break;
                 case 'root_change':
                     handleStatChange('root');
                     break;
                 case 'atk_mega':
                     gameState.baseAttack += item.bonus;
                     logToConsole(`•Nhận vĩnh viễn **+${item.bonus} Tấn Công**!`);
                     break;
            }
            
            // Reset Auction State
            gameState.auctionItem = null;
            gameState.auctionPrice = 0;
            gameState.auctionBidder = null;
            
            calculateStats();
            updateUI();
            renderView('Trade');
            window.saveGame(gameState);
        }

        window.buyItem = function(item) {
            if (gameState.spiritStone < item.price) {
                logToConsole(`XKhông đủ Linh Thạch! Cần ${item.price.toLocaleString()} LT.`);
                return;
            }

            gameState.spiritStone -= item.price;
            logToConsole(`•Bạn đã mua **${item.name}** với giá **${item.price.toLocaleString()} LT**.`);

            switch (item.type) {
                case 'exp':
                    gameState.experience += item.bonus;
                    logToConsole(`•Nhận **+${item.bonus} Tu Vi**.`);
                    checkLevelUp();
                    break;
                case 'def':
                    gameState.baseDefense += item.bonus;
                    logToConsole(`•Nhận vĩnh viễn **+${item.bonus} Phòng Thủ**.`);
                    break;
                case 'breakthrough':
                    gameState.inventory['Trúc Cơ Đan'] = (gameState.inventory['Trúc Cơ Đan'] || 0) + item.bonus;
                    logToConsole(`•Nhận **+${item.bonus} Trúc Cơ Đan**.`);
                    break;
                case 'mp':
                    gameState.currentMP = Math.min(gameState.maxMP, gameState.currentMP + item.bonus);
                    logToConsole(`•Hồi phục **+${item.bonus} Linh Khí**.`);
                    break;
                case 'hp':
                    // Tăng HP Tối Đa vĩnh viễn (0.5% * số cấp)
                    gameState.maxHP *= (1 + item.bonus / 100);
                    gameState.currentHP *= (1 + item.bonus / 100);
                    logToConsole(`•Tăng **${(item.bonus * 100).toFixed(1)}% Max HP** vĩnh viễn.`);
                    calculateStats(); // Recalculate based on new maxHP
                    break;
                case 'atk':
                    gameState.baseAttack += item.bonus;
                    logToConsole(`•Nhận vĩnh viễn **+${item.bonus} Tấn Công**.`);
                    break;
            }

            calculateStats();
            updateUI();
            renderView('Trade');
            window.saveGame(gameState);
        }
        
        function handleStatChange(type) {
            let statList, statNameKey, statValueKey, oldStat, newStat;
            let logType;
            
            if (type === 'bone') {
                statList = BONE_QUALITIES;
                statNameKey = 'boneQualityName';
                statValueKey = 'boneQuality';
                oldStat = gameState.boneQualityName;
                logType = "Căn Cốt";
            } else if (type === 'root') {
                statList = SPIRIT_ROOTS;
                statNameKey = 'spiritRootName';
                statValueKey = 'spiritRoot';
                oldStat = gameState.spiritRootName;
                logType = "Linh Căn";
            } else {
                return;
            }
            
            // Loại bỏ các chỉ số cấp thấp hơn chỉ số hiện tại để đảm bảo nâng cấp (tăng tỷ lệ thành công)
            const oldIndex = statList.findIndex(s => s.name === oldStat);
            const upgradeList = statList.slice(oldIndex + 1);
            
            if (upgradeList.length === 0) {
                 logToConsole(`•**${logType}** của bạn đã đạt cảnh giới tối cao (${oldStat}).`);
                 return;
            }
            
            // Chỉ định rarity cho các chỉ số nâng cấp
            const totalRarity = upgradeList.reduce((sum, s) => sum + s.rarity, 0);
            
            // Cơ hội thất bại (nếu thất bại thì giữ nguyên chỉ số hiện tại)
            if (Math.random() < 0.25) { // 25% fail chance even with pills
                 logToConsole(`X**${logType}** cải tạo thất bại. May mắn giữ nguyên phẩm chất. Tồn kho thuốc còn: ${gameState.inventory['Cải Cốt Đan'] || gameState.inventory['Tẩy Tủy Đan']}.`);
                 return;
            }

            // Chọn chỉ số mới (đảm bảo nó là cấp cao hơn)
            newStat = pickRandomStat(upgradeList);
            
            gameState[statNameKey] = newStat.name;
            gameState[statValueKey] = newStat.multiplier;
            
            logToConsole(`!CẢI TẠO THÀNH CÔNG: **${logType}** của bạn đã thăng lên **${newStat.name}**!`);
            
            calculateStats();
            updateUI();
            window.saveGame(gameState);
        }

        window.sellLoot = function(itemName, amount = 1) {
             if (!gameState.inventory[itemName] || gameState.inventory[itemName] < amount) {
                 logToConsole(`XKhông đủ ${itemName} để bán.`);
                 return;
             }
             
             const price = LOOT_PRICES[itemName]?.price || 0;
             const totalSale = price * amount;
             
             gameState.inventory[itemName] -= amount;
             gameState.spiritStone += totalSale;
             
             logToConsole(`•Đã bán **${itemName} x${amount}** thu về **${totalSale.toLocaleString()} LT**.`);
             
             updateUI();
             renderView('Trade');
             window.saveGame(gameState);
        }


        // --- SECT & CULTIVATION METHOD LOGIC (MỚI) ---
        
        window.handleJoinSect = function(sect) {
            const requiredRealmIndex = sect.requirement;
            
            if (gameState.sectName) {
                 return logToConsole(`XBạn đã là đệ tử của **${gameState.sectName}**. Không thể gia nhập tông môn khác.`);
            }
            
            if (gameState.realmIndex < requiredRealmIndex) {
                 return logToConsole(`XBạn không đủ cảnh giới để gia nhập **${sect.name}** (Yêu cầu: **${REALMS[requiredRealmIndex].name}** trở lên).`);
            }
            
            gameState.sectName = sect.name;
            gameState.sectBenefits = { expBonus: sect.expBonus, defBonus: sect.defBonus };
            gameState.sectContribution = 0;
            gameState.sectRank = 'Phổ Thông Đệ Tử';
            
            logToConsole(`§Chúc mừng! Bạn đã gia nhập **${sect.name}**!`);
            calculateStats();
            updateUI();
            renderView('Sect');
            window.saveGame(gameState);
        }
        
        window.handleContribute = function() {
            if (!gameState.sectName) {
                 return logToConsole("XBạn chưa gia nhập Tông Môn.");
            }
            
            const contributionCost = 1000;
            const contributionGain = 100;
            
            if (gameState.spiritStone < contributionCost) {
                 return logToConsole(`XKhông đủ Linh Thạch để cống hiến (Cần ${contributionCost.toLocaleString()} LT).`);
            }
            
            gameState.spiritStone -= contributionCost;
            gameState.sectContribution += contributionGain;
            
            logToConsole(`•Cống hiến thành công! Nhận **+${contributionGain} Cống Hiến**.`);
            
            // Check Rank Up
            if (gameState.sectContribution >= 10000 && gameState.sectRank === 'Phổ Thông Đệ Tử') {
                 gameState.sectRank = 'Nội Môn Đệ Tử';
                 logToConsole(`!CHÚC MỪNG: Bạn được thăng lên **Nội Môn Đệ Tử**!`);
            } else if (gameState.sectContribution >= 50000 && gameState.sectRank === 'Nội Môn Đệ Tử') {
                 gameState.sectRank = 'Chân Truyền Đệ Tử';
                 logToConsole(`!CHÚC MỪNG: Bạn được thăng lên **Chân Truyền Đệ Tử**!`);
            }
            
            updateUI();
            renderView('Sect');
            window.saveGame(gameState);
        }
        
        // HÀM MỚI: Học Công Pháp (Tàng Kinh Các)
        window.learnCultivationMethod = function(method) {
            // Check if already learned or equipped
            if (gameState.learnedMethods.includes(method.name)) {
                 return logToConsole(`XBạn đã học công pháp **${method.name}** rồi.`);
            }
            
            // Check Tông Môn Requirement (Only for Sect Skills)
            if (method.isSectSkill) {
                 if (!gameState.sectName) {
                     return logToConsole("XĐây là công pháp Tông Môn, bạn cần gia nhập Tông Môn.");
                 }
                 if (gameState.sectContribution < method.sectContribution) {
                     return logToConsole(`XKhông đủ Cống Hiến Tông Môn (Cần ${method.sectContribution.toLocaleString()}).`);
                 }
            } else {
                 // Check Money for general methods
                 if (gameState.spiritStone < method.cost) {
                     return logToConsole(`XKhông đủ Linh Thạch (Cần ${method.cost.toLocaleString()} LT).`);
                 }
            }
            
            // Deduct Cost
            if (method.isSectSkill) {
                 gameState.sectContribution -= method.sectContribution;
                 logToConsole(`•Mất **${method.sectContribution.toLocaleString()} Cống Hiến** để học.`);
            } else {
                 gameState.spiritStone -= method.cost;
                 logToConsole(`•Mất **${method.cost.toLocaleString()} Linh Thạch** để học.`);
            }
            
            // Learn & Equip
            gameState.learnedMethods.push(method.name);
            window.equipCultivationMethod(method);
            
            logToConsole(`§Học thành công **${method.name}** và đã tự động trang bị.`);
            updateUI();
            renderView('Sect');
            window.saveGame(gameState);
        }
        
        // HÀM MỚI: Trang bị Công Pháp
        window.equipCultivationMethod = function(method) {
            if (!gameState.learnedMethods.includes(method.name)) {
                 return logToConsole(`XBạn chưa học công pháp **${method.name}**.`);
            }
            
            gameState.cultivationMethod = method;
            gameState.cultivationMethodName = method.name;
            
            logToConsole(`•Trang bị thành công công pháp **${method.name}**.`);
            calculateStats();
            updateUI();
            renderView('Sect');
            window.saveGame(gameState);
        }


        // --- UI & RENDER FUNCTIONS ---

        function updateUI() {
            // Cập nhật Cảnh Giới
            const currentRealm = REALMS[gameState.realmIndex];
            document.getElementById('stat-realm').textContent = currentRealm.name;
            document.getElementById('stat-realm').className = `${currentRealm.color} font-bold`;

            // Cập nhật Linh Thạch
            document.getElementById('stat-money').textContent = gameState.spiritStone.toLocaleString();

            // Cập nhật Công Pháp
            document.getElementById('stat-cultivation-method').textContent = gameState.cultivationMethodName || "Chưa có";
            
            // Cập nhật Căn Cốt/Linh Căn
            document.getElementById('stat-bone').textContent = gameState.boneQualityName;
            document.getElementById('stat-spirit-root').textContent = gameState.spiritRootName;

            // Cập nhật Chỉ số Chiến đấu
            document.getElementById('stat-attack').textContent = gameState.totalAttack.toLocaleString();
            document.getElementById('stat-defense').textContent = gameState.totalDefense.toLocaleString();

            // Cập nhật HP
            const hpPercent = (gameState.currentHP / gameState.maxHP) * 100;
            document.getElementById('stat-hp').textContent = `${gameState.currentHP.toFixed(0)}/${gameState.maxHP.toFixed(0)}`;
            document.getElementById('hp-progress').style.width = `${hpPercent.toFixed(0)}%`;
            
            // Cập nhật MP
            const mpPercent = (gameState.currentMP / gameState.maxMP) * 100;
            document.getElementById('stat-mp').textContent = `${gameState.currentMP.toFixed(0)}/${gameState.maxMP.toFixed(0)}`;
            document.getElementById('mp-progress').style.width = `${mpPercent.toFixed(0)}%`;

            // Cập nhật EXP
            const expToNext = currentRealm.maxExp;
            const expPercent = (gameState.experience / expToNext) * 100;
            document.getElementById('stat-exp').textContent = `${gameState.experience.toLocaleString()} / ${expToNext.toLocaleString()}`;
            document.getElementById('exp-progress').style.width = `${expPercent.toFixed(0)}%`;
            
            // Cập nhật Tông Môn
            if (gameState.sectName) {
                 document.getElementById('sect-info').innerHTML = `
                      <p class="text-sm text-green-400">Tông Môn: **${gameState.sectName}**</p>
                      <p class="text-sm text-blue-400">Thân phận: **${gameState.sectRank}**</p>
                      <p class="text-sm text-orange-400">Cống Hiến: **${gameState.sectContribution.toLocaleString()}**</p>
                 `;
            } else {
                 document.getElementById('sect-info').innerHTML = `<p class="text-sm text-red-400">Chưa gia nhập Tông Môn</p>`;
            }
        }

        window.switchView = function(viewName) {
            gameState.currentView = viewName;
            
            // Update Tab Active State
            document.querySelectorAll('.tab-button').forEach(btn => {
                 btn.classList.remove('active');
            });
            document.getElementById(`tab-${viewName}`).classList.add('active');
            
            // Manage Game Loops
            if (viewName === 'TuoXian') {
                 if (combatInterval) clearInterval(combatInterval);
                 if (npcCombatInterval) clearInterval(npcCombatInterval);
                 combatInterval = null;
                 npcCombatInterval = null;
                 startTuoXianLoop();
                 gameState.currentMonster = null; // Clear combat state
                 gameState.currentNPCCombat = null;
            } else if (viewName === 'Combat' || viewName === 'NPC') {
                 if (tuXianInterval) clearInterval(tuXianInterval);
                 tuXianInterval = null;
                 // Combat/NPC loops are started by action functions (handleStartCombat/handleStartNPCCombat)
            } else {
                 if (combatInterval) clearInterval(combatInterval);
                 if (npcCombatInterval) clearInterval(npcCombatInterval);
                 combatInterval = null;
                 npcCombatInterval = null;
                 startTuoXianLoop(); // Resume TuoXian in non-combat tabs
                 gameState.currentMonster = null;
                 gameState.currentNPCCombat = null;
            }

            // Render Content
            renderView(viewName);
            updateUI();
        }

        function renderView(viewName) {
            const contentDiv = document.getElementById('main-content');
            
            // --- Tọa Thiền View ---
            if (viewName === 'TuoXian') {
                let expRate = (10 * gameState.expMultiplier).toFixed(0);
                contentDiv.innerHTML = `
                    <h2 class="text-3xl text-center text-green-300 mb-4">KHU VỰC TỌA THIỀN</h2>
                    <div class="pixel-card bg-gray-600 p-4 text-center">
                        <p class="text-xl">Đang Tọa Thiền...</p>
                        <p class="text-lg text-yellow-300 mt-2">Tốc độ tu luyện: **${expRate} Tu Vi/giây**</p>
                        ${gameState.cultivationMethodName ? 
                           `<p class="text-sm text-blue-300">Công Pháp: **${gameState.cultivationMethodName}** (x${gameState.cultivationMethod.bonus.expMultiplier})</p>` :
                           `<p class="text-sm text-red-400 font-bold">KHÔNG CÔNG PHÁP! Tốc độ x1.0</p>`
                        }
                    </div>
                    <div class="mt-6 text-center">
                         <h3 class="text-2xl text-yellow-300 mb-3">TÚI TRỮ VẬT</h3>
                         <div class="pixel-card bg-gray-600 p-4">
                              ${Object.keys(gameState.inventory).filter(key => gameState.inventory[key] > 0).length > 0 ? 
                                   Object.keys(gameState.inventory).filter(key => gameState.inventory[key] > 0).map(key => 
                                   `<p class="text-lg flex justify-between">${key}: <span class="text-orange-300">${gameState.inventory[key]}x</span></p>`
                                   ).join('') :
                                   `<p class="text-lg text-gray-400">Túi trữ vật trống.</p>`
                              }
                         </div>
                    </div>
                `;
            
            // --- Combat View ---
            } else if (viewName === 'Combat') {
                if (gameState.currentMonster) {
                    // In Combat Screen (Wilderness/Dungeon)
                    const monster = gameState.currentMonster;
                    const hpPercent = (monster.currentHp / monster.maxHp) * 100;
                    
                    contentDiv.innerHTML = `
                        <h2 class="text-3xl text-center text-red-400 mb-4">${gameState.currentCombatMode === 'Dungeon' ? 'ĐÁNH BOSS PHÓ BẢN' : 'CHIẾN ĐẤU HOANG DÃ'}</h2>
                        
                        <div class="pixel-card bg-red-800 border-red-500 p-4 mb-4">
                            <h3 class="text-2xl text-yellow-300">${monster.name}</h3>
                            <p class="text-lg text-red-300">HP: ${monster.currentHp.toFixed(0)}/${monster.maxHp.toFixed(0)}</p>
                            <div class="progress-bar-monster-hp mt-1">
                                <div class="progress-fill-monster-hp" style="width: ${hpPercent.toFixed(0)}%"></div>
                            </div>
                            <p class="text-lg text-red-300 mt-2">Tấn Công: ${monster.attack.toLocaleString()}</p>
                        </div>
                        
                        <h3 class="text-2xl text-yellow-300 mt-4 mb-2 text-center">HÀNH ĐỘNG</h3>
                        <div class="grid grid-cols-3 gap-4">
                            ${SKILLS.map(skill => `
                                <button class="game-button p-2 text-base" onclick="handleActionSkill(${JSON.stringify(skill).replace(/'/g, 'QUOTE_REPLACER').replace(/\"/g, "\'").replace(/QUOTE_REPLACER/g, '\"')})"
                                        ${gameState.currentMP < skill.mpCost ? 'disabled' : ''}>
                                    ${skill.name} (${skill.mpCost} MP)
                                </button>
                            `).join('')}
                        </div>
                        <button class="game-button p-2 text-base w-full mt-4 bg-red-600 border-red-300 hover:bg-red-700" onclick="switchView('TuoXian')">CHẠY TRỐN (Tọa Thiền)</button>
                    `;
                } else {
                    // Out of Combat Screen (Wilderness/Dungeon selection)
                    const autoCombatButtonText = combatInterval ? 'DỪNG TỰ ĐỘNG' : 'BẬT TỰ ĐỘNG CHIẾN ĐẤU';
                    contentDiv.innerHTML = `
                        <h2 class="text-3xl text-center text-red-400 mb-4">CHIẾN ĐẤU HOANG DÃ</h2>
                        <div class="flex justify-center mb-6">
                            <button id="start-auto-combat-button" class="game-button p-3 text-lg bg-indigo-600 border-indigo-300 hover:bg-indigo-700" 
                                    onclick="handleActionToggleAutoCombat()">
                                ${autoCombatButtonText}
                            </button>
                        </div>
                        
                        <h3 class="text-2xl text-yellow-300">Quái Vật Khu Vực</h3>
                        <div class="grid grid-cols-2 gap-4 mt-2">
                            ${MONSTERS.map(monster => `
                                <div class="pixel-card bg-gray-600 p-3 flex justify-between items-center">
                                    <div>
                                        <p class="text-lg text-red-300">${monster.name}</p>
                                        <p class="text-xs text-gray-400">Yêu cầu: ${monster.requiredRealm}</p>
                                    </div>
                                    <button class="game-button text-xs p-1" 
                                            onclick="handleStartCombat(${monster.id}, 'Wilderness')"
                                            ${gameState.realmIndex < monster.minRealm ? 'disabled' : ''}>
                                        CHIẾN ĐẤU
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                        
                        <h2 class="text-3xl text-center text-purple-400 mt-6 mb-4">PHÓ BẢN (DUGEON)</h2>
                         <div class="grid grid-cols-2 gap-4 mt-2">
                             ${DUNGEONS.map(dungeon => `
                                 <div class="pixel-card bg-purple-800 border-purple-500 p-3 flex justify-between items-center">
                                     <div>
                                         <p class="text-lg text-purple-300">${dungeon.name}</p>
                                         <p class="text-xs text-gray-400">Yêu cầu: ${dungeon.requiredRealm}</p>
                                     </div>
                                     <button class="game-button text-xs p-1" 
                                             onclick="handleStartCombat(null, 'Dungeon', '${dungeon.id}')"
                                             ${gameState.realmIndex < dungeon.realmIndex ? 'disabled' : ''}>
                                         TIẾN VÀO
                                     </button>
                                 </div>
                             `).join('')}
                         </div>
                    `;
                }

            // --- Trade View ---
            } else if (viewName === 'Trade') {
                const dailyItem = gameState.dailyItem;
                const auctionItem = gameState.auctionItem;

                let auctionHTML = '';
                if (auctionItem) {
                    const isHighestBidder = gameState.auctionBidder === 'Bạn';
                    auctionHTML = `
                        <h3 class="text-2xl text-center mt-4 text-red-400">ĐẤU GIÁ HỘI (Ngày ${gameState.currentDay} - Vòng ${gameState.currentDay - gameState.lastAuctionDay})</h3>
                        <div class="pixel-card bg-red-800 border-red-500 p-4 mt-2">
                            <p class="text-xl text-yellow-300 font-bold">${auctionItem.name} (Hiếm)</p>
                            <p class="text-sm text-gray-300">${auctionItem.description}</p>
                            <p class="text-lg mt-2">Giá hiện tại: <span class="text-green-400 font-bold">${gameState.auctionPrice.toLocaleString()} LT</span></p>
                            <p class="text-lg mb-4">Người đặt giá cao nhất: <span class="text-orange-400">${gameState.auctionBidder}</span></p>
                            
                            <button class="game-button text-base p-2 w-full mb-2" 
                                    onclick="handleBid(${JSON.stringify(auctionItem).replace(/'/g, 'QUOTE_REPLACER').replace(/\"/g, "\'").replace(/QUOTE_REPLACER/g, '\"')}, ${gameState.auctionPrice})"
                                    ${isHighestBidder && gameState.currentDay === gameState.lastAuctionDay ? 'disabled' : ''}>
                                ${isHighestBidder ? 'ĐÃ LÀ GIÁ CAO NHẤT' : 'ĐẶT GIÁ (Giá tăng 10%)'}
                            </button>
                            
                            <button class="game-button text-base p-2 w-full bg-green-600 border-green-300 hover:bg-green-700"
                                    onclick="handleBuyAuctionItem(${JSON.stringify(auctionItem).replace(/'/g, 'QUOTE_REPLACER').replace(/\"/g, "\'").replace(/QUOTE_REPLACER/g, '\"')}, ${gameState.auctionPrice})"
                                    ${!isHighestBidder ? 'disabled' : ''}>
                                MUA NGAY (DÀNH CHO NGƯỜI ĐẶT GIÁ CAO NHẤT)
                            </button>
                        </div>
                    `;
                } else if (gameState.currentDay % 30 === 1 && gameState.lastAuctionDay !== gameState.currentDay) {
                     // Nếu đang ngày 1 nhưng chưa initialize (có thể do lỗi, nên hiển thị nút initialize)
                     auctionHTML = `
                         <h3 class="text-2xl text-center mt-4 text-red-400">ĐẤU GIÁ HỘI</h3>
                         <p class="text-center text-lg pixel-card bg-gray-700 mt-2 text-gray-400">Đấu Giá Hội hôm nay đang được chuẩn bị.</p>
                         <button class="game-button p-2 text-base w-full mt-2" onclick="initializeAuction()">MỞ ĐẤU GIÁ</button>
                     `;
                } else if (gameState.currentDay % 30 === 1 && gameState.lastAuctionDay === gameState.currentDay) {
                     auctionHTML = `
                         <h3 class="text-2xl text-center mt-4 text-red-400">ĐẤU GIÁ HỘI</h3>
                         <p class="text-center text-lg pixel-card bg-gray-700 mt-2 text-gray-400">Đấu Giá Hội hôm nay đã kết thúc!</p>
                     `;
                } else {
                     auctionHTML = `
                         <h3 class="text-2xl text-center mt-4 text-red-400">ĐẤU GIÁ HỘI</h3>
                         <p class="text-center text-lg pixel-card bg-gray-700 mt-2 text-gray-400">Chờ đến đầu tháng (Ngày ${Math.ceil(gameState.currentDay / 30) * 30 + 1}) để tham gia Đấu Giá.</p>
                     `;
                }
                
                // Inventory Sell HTML
                const inventoryItems = Object.keys(gameState.inventory).filter(key => gameState.inventory[key] > 0);
                const commonItems = inventoryItems.filter(key => LOOT_PRICES[key]?.type === 'common');
                
                const sellLootHTML = commonItems.map(itemName => `
                    <div class="flex justify-between items-center my-2 pixel-card bg-gray-700">
                        <p class="text-lg">${itemName}: <span class="text-yellow-300">${gameState.inventory[itemName]}x</span></p>
                        <div class="flex space-x-2">
                             <button class="game-button text-xs p-1" onclick="sellLoot('${itemName}', 1)">Bán 1 (${(LOOT_PRICES[itemName]?.price || 0).toLocaleString()} LT)</button>
                             <button class="game-button text-xs p-1 bg-red-600 border-red-300 hover:bg-red-700" onclick="sellLoot('${itemName}', ${gameState.inventory[itemName]})">Bán Hết (${(LOOT_PRICES[itemName]?.price * gameState.inventory[itemName] || 0).toLocaleString()} LT)</button>
                        </div>
                    </div>
                `).join('');
                
                const rareItems = inventoryItems.filter(key => LOOT_PRICES[key]?.type !== 'common');

                contentDiv.innerHTML = `
                    <h2 class="text-3xl text-center text-yellow-300 mb-4">THƯƠNG HỘI</h2>
                    
                    <h3 class="text-2xl text-center text-green-400">CỬA HÀNG ĐẶC BIỆT HÀNG NGÀY</h3>
                    <div class="pixel-card bg-gray-600 p-4 mt-2">
                         <div class="flex justify-between items-center my-2 pixel-card bg-green-700 border-green-500">
                             <div>
                                 <p class="text-xl text-green-300 font-bold">${dailyItem.name} <span class="text-yellow-100">(${dailyItem.price.toLocaleString()} LT)</span></p>
                                 <p class="text-sm text-gray-400">${dailyItem.description}</p>
                             </div>
                             <button class="game-button text-base p-2" onclick="buyItem(${JSON.stringify(dailyItem).replace(/'/g, 'QUOTE_REPLACER').replace(/\"/g, "\'").replace(/QUOTE_REPLACER/g, '\"')})">MUA</button>
                         </div>
                    </div>
                    
                    <h3 class="text-2xl text-center mt-4 text-blue-400">VẬT PHẨM THƯỜNG TRỰC</h3>
                    <div class="pixel-card bg-gray-600 p-4 mt-2">
                        ${TRADE_ITEMS.map(item => `
                            <div class="flex justify-between items-center my-2 pixel-card bg-gray-700">
                                <div>
                                    <p>${item.name} <span class="text-yellow-300">(${item.price.toLocaleString()} LT)</span></p>
                                    <p class="text-xs text-gray-400">${item.description}</p>
                                </div>
                                <button class="game-button text-xs p-1" onclick="buyItem(${JSON.stringify(item).replace(/'/g, 'QUOTE_REPLACER').replace(/\"/g, "\'").replace(/QUOTE_REPLACER/g, '\"')})">MUA</button>
                            </div>
                        `).join('')}
                    </div>

                    ${auctionHTML}
                    
                    <h3 class="text-2xl text-center mt-4 text-orange-400">BÁN VẬT PHẨM THU HOẠCH</h3>
                    <div class="pixel-card bg-gray-600 p-4 mt-2">
                        ${commonItems.length > 0 ? `<p class="text-base text-green-300 mt-2 mb-1">--- Vật Phẩm Phổ Thông ---</p>` : ''}
                        ${sellLootHTML}
                        
                        ${rareItems.length > 0 ? `<p class="text-base text-red-400 mt-4 mb-1">--- BẢO VẬT HIẾM (Giá Cao) ---</p>` : ''}
                        ${inventoryItems.filter(key => LOOT_PRICES[key]?.type === 'rare' || LOOT_PRICES[key]?.type === 'super_rare').map(itemName => `
                            <div class="flex justify-between items-center my-2 pixel-card bg-red-800 border-red-500">
                                <p class="text-xl text-red-300 font-bold">${itemName} HIẾM: <span class="text-yellow-100">${gameState.inventory[itemName]}x</span></p>
                                <div class="flex space-x-2">
                                     <button class="game-button text-xs p-1 bg-yellow-600 border-yellow-300 hover:bg-yellow-700" onclick="sellLoot('${itemName}', 1)">Bán Nhanh (${(LOOT_PRICES[itemName]?.price || 0).toLocaleString()} LT)</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            
            // --- Sect View ---
            } else if (viewName === 'Sect') {
                const currentSect = SECTS.find(s => s.name === gameState.sectName);
                
                let sectDetailsHTML = '';
                if (currentSect) {
                     sectDetailsHTML = `
                         <div class="pixel-card bg-green-800 border-green-500 p-4 mt-4 text-center">
                             <h3 class="text-2xl text-green-300 font-bold">Tông Môn: ${currentSect.name}</h3>
                             <p class="text-lg mt-2">Thân phận: **${gameState.sectRank}**</p>
                             <p class="text-lg">Cống Hiến: **${gameState.sectContribution.toLocaleString()}**</p>
                             <p class="text-sm text-gray-400">Lợi ích: Tăng ${(currentSect.expBonus - 1) * 100}% Tu Vi, +${currentSect.defBonus} Phòng Thủ.</p>
                             <button class="game-button p-2 text-base w-full mt-4" onclick="handleContribute()">CỐNG HIẾN LINH THẠCH (1,000 LT = 100 Cống Hiến)</button>
                         </div>
                         
                         <h3 class="text-2xl text-center text-yellow-300 mt-6 mb-4">TÀNG KINH CÁC (Học Công Pháp)</h3>
                         <div class="grid grid-cols-2 gap-4">
                             ${CULTIVATION_METHODS.map(method => {
                                 const isLearned = gameState.learnedMethods.includes(method.name);
                                 const isEquipped = gameState.cultivationMethodName === method.name;
                                 let costDisplay = method.isSectSkill 
                                     ? `${method.sectContribution.toLocaleString()} Cống Hiến`
                                     : `${method.cost.toLocaleString()} LT`;
                                 
                                 let canAfford = method.isSectSkill 
                                     ? gameState.sectContribution >= (method.sectContribution || 0)
                                     : gameState.spiritStone >= (method.cost || 0);
                                     
                                 let buttonText = isEquipped ? 'ĐANG TRANG BỊ' : isLearned ? 'TRANG BỊ' : 'HỌC';
                                 let isDisabled = isEquipped || (!isLearned && !canAfford) || (!isLearned && method.isSectSkill && !gameState.sectName);
                                 
                                 let action = isLearned ? `equipCultivationMethod(${JSON.stringify(method).replace(/'/g, 'QUOTE_REPLACER').replace(/\"/g, "\'").replace(/QUOTE_REPLACER/g, '\"')})` : `learnCultivationMethod(${JSON.stringify(method).replace(/'/g, 'QUOTE_REPLACER').replace(/\"/g, "\'").replace(/QUOTE_REPLACER/g, '\"')})`;

                                 return `
                                     <div class="pixel-card p-3 flex flex-col justify-between items-start ${isEquipped ? 'bg-indigo-700 border-indigo-400' : 'bg-gray-600'}">
                                         <div>
                                             <p class="text-lg text-blue-300 font-bold">${method.name}</p>
                                             <p class="text-sm text-gray-400">${method.description}</p>
                                             <p class="text-xs mt-1 ${isLearned ? 'text-green-400' : 'text-orange-400'}">${isLearned ? 'Đã Học' : `Giá: ${costDisplay}`}</p>
                                         </div>
                                         <button class="game-button text-xs p-1 mt-2 w-full" onclick="${action}" ${isDisabled ? 'disabled' : ''}>
                                             ${buttonText}
                                         </button>
                                     </div>
                                 `;
                             }).join('')}
                         </div>
                     `;
                } else {
                     sectDetailsHTML = `
                         <h3 class="text-2xl text-center text-red-400 mb-4">CHƯA GIA NHẬP TÔNG MÔN</h3>
                         <p class="text-lg text-center text-gray-400 mb-4">Hãy chọn một Tông Môn để nhận Công Pháp và tài nguyên!</p>
                         <div class="grid grid-cols-2 gap-4">
                              ${SECTS.map(sect => `
                                  <div class="pixel-card bg-gray-600 p-3">
                                      <p class="text-xl text-blue-300 font-bold">${sect.name}</p>
                                      <p class="text-sm text-gray-400">Yêu cầu: ${REALMS[sect.requirement].name}</p>
                                      <p class="text-sm text-green-400">Lợi ích: Tăng ${(sect.expBonus - 1) * 100}% Tu Vi, +${sect.defBonus} Phòng Thủ.</p>
                                      <button class="game-button text-xs p-1 w-full mt-2" onclick="handleJoinSect(${JSON.stringify(sect).replace(/'/g, 'QUOTE_REPLACER').replace(/\"/g, "\'").replace(/QUOTE_REPLACER/g, '\"')})"
                                              ${gameState.realmIndex < sect.requirement ? 'disabled' : ''}>
                                          GIA NHẬP
                                      </button>
                                  </div>
                              `).join('')}
                         </div>
                     `;
                }

                contentDiv.innerHTML = `
                    <h2 class="text-3xl text-center text-blue-300 mb-4">TÔNG MÔN</h2>
                    ${sectDetailsHTML}
                `;

            // --- NPC View ---
            } else if (viewName === 'NPC') {
                 if (gameState.currentNPCCombat) {
                      // In NPC Combat Screen
                      const npc = gameState.currentNPCCombat;
                      const hpPercent = (npc.currentHp / npc.maxHp) * 100;
                      
                      contentDiv.innerHTML = `
                          <h2 class="text-3xl text-center text-red-400 mb-4">THÁCH ĐẤU NPC</h2>
                          
                          <div class="pixel-card bg-red-800 border-red-500 p-4 mb-4">
                              <h3 class="text-2xl text-yellow-300">${npc.name} (${npc.realm})</h3>
                              <p class="text-lg text-red-300">HP: ${npc.currentHp.toFixed(0)}/${npc.maxHp.toFixed(0)}</p>
                              <div class="progress-bar-monster-hp mt-1">
                                  <div class="progress-fill-monster-hp" style="width: ${hpPercent.toFixed(0)}%"></div>
                              </div>
                              <p class="text-lg text-red-300 mt-2">Tấn Công: ${npc.attack.toLocaleString()} | Phòng Thủ: ${npc.defense.toLocaleString()}</p>
                          </div>
                          
                          <h3 class="text-2xl text-yellow-300 mt-4 mb-2 text-center">HÀNH ĐỘNG</h3>
                          <div class="grid grid-cols-3 gap-4">
                              ${SKILLS.map(skill => `
                                  <button class="game-button p-2 text-base" onclick="handleActionSkill(${JSON.stringify(skill).replace(/'/g, 'QUOTE_REPLACER').replace(/\"/g, "\'").replace(/QUOTE_REPLACER/g, '\"')})"
                                          ${gameState.currentMP < skill.mpCost ? 'disabled' : ''}>
                                      ${skill.name} (${skill.mpCost} MP)
                                  </button>
                              `).join('')}
                          </div>
                          <button class="game-button p-2 text-base w-full mt-4 bg-red-600 border-red-300 hover:bg-red-700" onclick="switchView('TuoXian')">CHẠY TRỐN (Tọa Thiền)</button>
                      `;
                      
                 } else {
                      // NPC Interaction Screen
                      let npcListHTML = MOCK_NPCS.map(npc => `
                           <div class="pixel-card bg-gray-600 p-3 flex justify-between items-center my-2">
                               <div>
                                   <p class="text-xl text-blue-300 font-bold">${npc.name} (${npc.realm})</p>
                                   <p class="text-sm text-gray-400">${npc.description}</p>
                               </div>
                               <div>
                                   ${npc.isChallengable ? 
                                        `<button class="game-button text-xs p-1" onclick="handleStartNPCCombat('${npc.id}')"
                                                 ${gameState.realmIndex < REALMS.findIndex(r => r.name === npc.realm) ? 'disabled' : ''}>
                                            THÁCH ĐẤU
                                        </button>` 
                                        : 
                                        `<button class="game-button text-xs p-1" disabled>TƯƠNG TÁC</button>`
                                   }
                               </div>
                           </div>
                      `).join('');
                      
                      contentDiv.innerHTML = `
                          <h2 class="text-3xl text-center text-purple-400 mb-4">GIAO TIẾP VỚI NPC</h2>
                          <p class="text-lg text-center text-gray-400 mb-4">Giao tiếp để nhận chỉ dẫn hoặc thách đấu để nhận thưởng.</p>
                          ${npcListHTML}
                      `;
                 }

            }
        }
        
        // --- FINAL INIT ---
        // Loaded/Initialized in startGame()
    </script>
</body>
</html>
